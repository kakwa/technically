<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Reversing WoWs Resource Format | Technically some technical stuff, or not.</title>

<meta property='og:title' content='Reversing WoWs Resource Format - Technically some technical stuff, or not.'>
<meta property='og:description' content='Introduction First, a disclaimer, this is the first time I&rsquo;m doing this kind of exercise, so the process described here is far from ideal, and the tools used less than adequate.
Also, I&rsquo;m writting this after various findings, so the process seems quite straight forward. In reallity, it was full of dead ends and flows of ideas (good and bad) that came-up while staring at hexdumps for hours.
Motivation I&rsquo;ve always wanted to play around World of Warships game content for various reasons, from extracting things like armor layouts or in game parameters to the 3D models themselves.'>
<meta property='og:url' content='http://localhost:1313/posts/wows_depack/'>
<meta property='og:site_name' content='Technically some technical stuff, or not.'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/bf9868bd766533e965b2eb1ed2d4ef76?s=256'><meta property='article:section' content='Posts'><meta property='article:published_time' content='2024-06-29T22:50:48&#43;02:00'><meta property='article:modified_time' content='2024-06-29T22:50:48&#43;02:00'><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@'><meta name='twitter:creator' content='@'>




<link rel="stylesheet" href="/css/style.css"><link rel='stylesheet' href='http://localhost:1313/css/custom.css'>



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="http://localhost:1313/posts/wows_depack/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="http://localhost:1313/">
          <h1 id="nav-heading" class="title is-4">Technically some technical stuff, or not.</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/kakwa'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:carpentier.pf@gmail.com'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg>
</i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/pfcarpentier'
            target='_blank' rel='me noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg>
</i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
    </div>
    
    <h2 class="subtitle is-6">June 29, 2024</h2>
    
    <h1 class="title">Reversing WoWs Resource Format</h1>
    
    <div class="content">
      <h1 id="introduction">Introduction</h1>
<p>First, a disclaimer, this is the first time I&rsquo;m doing this kind of exercise, so the process described here is far from ideal, and the tools used less than adequate.</p>
<p>Also, I&rsquo;m writting this after various findings, so the process seems quite straight forward. In reallity, it was full of dead ends and flows of ideas (good and bad) that came-up while staring at hexdumps for hours.</p>
<h2 id="motivation">Motivation</h2>
<p>I&rsquo;ve always wanted to play around World of Warships game content for various reasons, from extracting things like armor layouts or in game parameters to the 3D models themselves.</p>
<p>There is already a tool that does that: <a href="https://forum.worldofwarships.eu/topic/113847-all-wows-unpack-tool-unpack-game-client-resources/">wows-unpack</a></p>
<p>But being an pro-OSS and working under linux, this tool doesn&rsquo;t suite me well.</p>
<p>It also doesn&rsquo;t fit my needs regarding having something that could be integrated into other programs easily</p>
<p>I also wanted to do as an intellectual exercise of reverse engineering.</p>
<h2 id="goals">Goals</h2>
<p>My goals are:</p>
<ul>
<li>Reverse the format, even partially (but enough to extract the data)* Document the format specification so other people could leverage it, and improve upon my implementation</li>
<li>Create a CLI tool with Linux/Unix as its main target</li>
<li>Create a library which can be reused (maybe through bindings) in other pieces of software.</li>
</ul>
<h1 id="reverse-engineering-process">Reverse Engineering process</h1>
<h2 id="intial-effort">Intial effort</h2>
<h3 id="looking-at-the-game-files">Looking at the Game files</h3>
<p>I started this reverse process a while back, around 2 years ago, but lost interest. Consequently I only have very fuzzy memories of the initial steps I took, and the original findings.</p>
<p>Anyway, the first step was simply to look at the game files and see were the bulk of the data was:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux Games/World of Warships » ls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> api-ms-win-crt-runtime-l1-1-0.dll  concrt140.dll             msvcp140_codecvt_ids.dll  Reports               vcruntime140_1.dll
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> api-ms-win-crt-stdio-l1-1-0.dll    crashes                   msvcp140.dll              res_packages          vcruntime140.dll
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> api-ms-win-crt-string-l1-1-0.dll   currentrealm.txt          patche                    res_unpack            Wallpapers
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> api-ms-win-crt-time-l1-1-0.dll     GameCheck                 placeholder.txt           screenshot            WorldOfWarships.exe
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> api-ms-win-crt-utility-l1-1-0.dll  lib                       platform64.dll            steam_api64.dll       wowsunpack.exe
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> app_type.xml                       mods_preferences.xml      preferences.xml           steam_autocloud.vdf   WOWSUnpackTool.cfg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> Aslain_Modpack                     msvcp140_1.dll            profile                   stuff                 WOWSUnpackTool.exe
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> Aslains_WoWs_Logs_Archiver.exe     msvcp140_2.dll            readme.rtf                ucrtbase.dll
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> bin                                msvcp140_atomic_wait.dll  replays                   user_preferences.xml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kakwa@linux Games/World of Warships » du -hd <span style="color:#ae81ff">1</span> | sort -h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>4.0K	./Reports
</span></span><span style="display:flex;"><span>12K	./patche
</span></span><span style="display:flex;"><span>2.8M	./Wallpapers
</span></span><span style="display:flex;"><span>4.2M	./GameCheck
</span></span><span style="display:flex;"><span>4.4M	./screenshot
</span></span><span style="display:flex;"><span>49M	./replays
</span></span><span style="display:flex;"><span>55M	./lib
</span></span><span style="display:flex;"><span>464M	./profile
</span></span><span style="display:flex;"><span>593M	./crashes
</span></span><span style="display:flex;"><span>1.2G	./bin
</span></span><span style="display:flex;"><span>62G	./res_packages
</span></span><span style="display:flex;"><span>73G	.
</span></span></code></pre></div><p>So here, the bulk of the data is in the <code>res_packages/</code> directory. Lets take a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux Games/World of Warships » ls res_packages                                                                                                                                                                                                                                                                 basecontent_0001.pkg           spaces_dock_dry_0001.pkg           spaces_greece_0001.pkg               spaces_sea_hope_0001.pkg              vehicles_level10_spain_0001.pkg      vehicles_level4_0001.pkg             vehicles_level6_panasia_0001.pkg     vehicles_level8_panamerica_0001.pkg
</span></span><span style="display:flex;"><span>camouflage_0001.pkg            spaces_dock_dunkirk_0001.pkg       spaces_honey_0001.pkg                spaces_shards_0001.pkg                vehicles_level10_uk_0001.pkg         vehicles_level4_ger_0001.pkg         vehicles_level6_premium_0001.pkg     vehicles_level8_panasia_0001.pkg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>spaces_dock_1_april_0001.pkg   spaces_faroe_0001.pkg              spaces_ridge_0001.pkg                vehicles_level10_panamerica_0001.pkg  vehicles_level3_panasia_0001.pkg     vehicles_level6_jap_0001.pkg         vehicles_level8_it_0001.pkg          z_vehicles_events_0001.pkg
</span></span><span style="display:flex;"><span>spaces_dock_azurlane_0001.pkg  spaces_fault_line_0001.pkg         spaces_ring_0001.pkg                 vehicles_level10_panasia_0001.pkg     vehicles_level3_uk_0001.pkg          vehicles_level6_ned_0001.pkg         vehicles_level8_jap_0001.pkg
</span></span><span style="display:flex;"><span>spaces_dock_dragon_0001.pkg    spaces_gold_harbor_0001.pkg        spaces_rotterdam_0001.pkg            vehicles_level10_ru_0001.pkg          vehicles_level3_usa_0001.pkg         vehicles_level6_panamerica_0001.pkg  vehicles_level8_ned_0001.pkg
</span></span></code></pre></div><p>Then use <code>file</code> to see if what type of files we are dealing with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux Games/World of Warships » cd res_packages 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » file *
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>spaces_dock_ny_0001.pkg:              data
</span></span><span style="display:flex;"><span>spaces_dock_ocean_0001.pkg:           data
</span></span><span style="display:flex;"><span>spaces_dock_prem_0001.pkg:            Microsoft DirectDraw Surface <span style="color:#f92672">(</span>DDS<span style="color:#f92672">)</span>: <span style="color:#ae81ff">4</span> x 4, compressed using DX10
</span></span><span style="display:flex;"><span>spaces_dock_rio_0001.pkg:             data
</span></span><span style="display:flex;"><span>spaces_dock_spb_0001.pkg:             data
</span></span><span style="display:flex;"><span>spaces_exterior_0001.pkg:             data
</span></span><span style="display:flex;"><span>spaces_faroe_0001.pkg:                OpenPGP Secret Key
</span></span><span style="display:flex;"><span>spaces_labyrinth_0001.pkg:            data
</span></span><span style="display:flex;"><span>spaces_lepve_0001.pkg:                data
</span></span><span style="display:flex;"><span>spaces_military_navigation_0001.pkg:  data
</span></span><span style="display:flex;"><span>spaces_naval_base_0001.pkg:           DOS executable <span style="color:#f92672">(</span>COM<span style="color:#f92672">)</span>, maybe with interrupt 22h, start instruction 0x8cbc075c 534dd337
</span></span><span style="display:flex;"><span>spaces_naval_defense_0001.pkg:        data
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>So mostly <code>data</code> i.e. unknown format, and looking at the files which are not <code>data</code>, they are in fact most likely false positives. So we are dealing with a custom format.</p>
<h3 id="investing-the-interesting-files">Investing the interesting files</h3>
<p>Next, lets try to see if we have some clear text strings in the files using the <code>strings</code> utility:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » strings *
</span></span><span style="display:flex;"><span>YyHIKzR
</span></span><span style="display:flex;"><span>+!?&lt;
</span></span><span style="display:flex;"><span>m:C-
</span></span><span style="display:flex;"><span>h4.1
</span></span><span style="display:flex;"><span>~s3o
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>2bm
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>$ <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>O<span style="color:#f92672">=</span>z$
</span></span><span style="display:flex;"><span>&lt;27P
</span></span><span style="display:flex;"><span><span style="color:#f92672">=</span>C<span style="color:#f92672">=</span>k<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>dQz<span style="color:#f92672">{</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>$Zm|
</span></span><span style="display:flex;"><span>$ZOc
</span></span><span style="display:flex;"><span>nV&amp;
</span></span><span style="display:flex;"><span>&lt;4n5
</span></span><span style="display:flex;"><span>r&gt;Zs%
</span></span><span style="display:flex;"><span>6?Iw
</span></span><span style="display:flex;"><span>KqM&amp;u
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Nada, that&rsquo;s just garbage. So we are dealing with a completely binary format.</p>
<p>Next, lets try to compress a file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Size before</span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » ls -l vehicles_level4_usa_0001.pkg                                                                                                                                                                                                                                      
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> kakwa kakwa <span style="color:#ae81ff">15356139</span> Jan <span style="color:#ae81ff">17</span> 19:01 vehicles_level4_usa_0001.pkg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compress</span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » gzip vehicles_level4_usa_0001.pkg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Size After</span>
</span></span><span style="display:flex;"><span>ls -l vehicles_level4_usa_0001.pkg.gz 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> kakwa kakwa <span style="color:#ae81ff">15332196</span> Jan <span style="color:#ae81ff">17</span> 19:01 vehicles_level4_usa_0001.pkg.gz
</span></span></code></pre></div><p>Ok, barely any change in size, which means the data is probably compressed (not a big surprise there since a lot of formats such as images are compressed).</p>
<p>Then, the process is a little fuzzy in my memory. But if I recall correctly, I did the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » hexdump -C vehicles_level4_usa_0001.pkg | less
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">95</span> <span style="color:#ae81ff">58</span> 7f <span style="color:#ae81ff">50</span> 9b e7 7d 7f  f4 2a <span style="color:#ae81ff">24</span> e2 <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">64</span> 7c bb  |.X.P..<span style="color:#f92672">}</span>..*$.Ud|.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  a4 be 5b <span style="color:#ae81ff">77</span> 8d e6 <span style="color:#ae81ff">45</span> 0e  <span style="color:#ae81ff">08</span> <span style="color:#ae81ff">83</span> ba 5d b1 b7 b8 <span style="color:#ae81ff">35</span>  |..<span style="color:#f92672">[</span>w..E....<span style="color:#f92672">]</span>...5|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  4a 2f e9 <span style="color:#ae81ff">71</span> d9 3f c4 e5  <span style="color:#ae81ff">45</span> 2a <span style="color:#ae81ff">05</span> a1 <span style="color:#ae81ff">92</span> eb 9d 2a  |J/.q.?..E*.....*|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">41</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">43</span> ab c3 <span style="color:#ae81ff">31</span> bc  c8 <span style="color:#ae81ff">97</span> 3b <span style="color:#ae81ff">41</span> c2 d0 f5 <span style="color:#ae81ff">82</span>  |wAsC..1...;A....|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000040</span>  fd 2e <span style="color:#ae81ff">69</span> e3 <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">97</span>  <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">01</span> d1 b4 <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">82</span> 8d <span style="color:#ae81ff">90</span>  |..i.w<span style="color:#e6db74">&#34;..W.......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000050  f1 fe 68 bc 76 f3 ed ac  c0 75 ae 51 c9 b9 21 72  |..h.v....u.Q..!r|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000060  1d 58 36 05 59 46 7a f7  fd 3c 90 6d d7 6d 7f 4c  |.X6.YFz..&lt;.m.m.L|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000070  77 f8 e3 e7 f7 f7 c7 e7  f9 7e bf cf fb e4 93 5f  |w........~....._|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span></code></pre></div><p>I hexdumped one of the file, looking for some pattern that would help me determine the type of compression used. I was looking for things like padding or signatures repeating within the .pkg file. I&rsquo;m not sure how, but I finally determined the compression used was <code>DEFLATE</code> (RFC 1951) (I vaguely remember <code>7f f0</code> being a marker, but I might be very well mistaken). In any case, <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">The Wikipedia page listing file signatures</a> is really useful, as well as Googling around candidate patterns.</p>
<p>I ended-up creating <a href="https://github.com/kakwa/brute-force-deflate">this tool</a> which tries to brute force deflate all the sections of the file, and sure enough, I was able to extract some interesting files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># Extracting stuff</span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » bf-deflate -i system_data_0001.pkg -o systemout                                                                                 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># look the file types we just extracted</span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » file systemout/* | tail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemout/000A15D8ED-000A15D8F3: ISO-8859 text, with no line terminators
</span></span><span style="display:flex;"><span>systemout/000A15D8F7-000A15EF9A: XML 1.0 document, ASCII text
</span></span><span style="display:flex;"><span>systemout/000A15EF9E-000A15EFA7: ISO-8859 text, with CR line terminators
</span></span><span style="display:flex;"><span>systemout/000A15EFAA-000A15F919: XML 1.0 document, ASCII text
</span></span><span style="display:flex;"><span>systemout/000A15F929-000A162634: exported SGML document, Unicode text, UTF-8 text, with CRLF line terminators
</span></span><span style="display:flex;"><span>systemout/000A162644-000A165D7C: ASCII text, with CRLF line terminators
</span></span><span style="display:flex;"><span>systemout/000A165D8C-000A16C774: ASCII text, with CRLF line terminators
</span></span><span style="display:flex;"><span>systemout/000A16C784-000A16D41A: exported SGML document, ASCII text, with CRLF line terminators
</span></span><span style="display:flex;"><span>systemout/000A16D41E-000A16D426: data
</span></span><span style="display:flex;"><span>systemout/bf-Xe4fzss:            empty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Look if we indeed got what &#34;file&#34; says it is</span>
</span></span><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » head systemout/000A15EFAA-000A15F919 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;?xml version<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;1.0&#34;</span> encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UTF-8&#34;</span> standalone<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no&#34;</span>?&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;root&gt;
</span></span><span style="display:flex;"><span>    &lt;Implements&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;VisionOwner&lt;/Interface&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;AtbaOwner&lt;/Interface&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;AirDefenceOwner&lt;/Interface&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;BattleLogicEntityOwner&lt;/Interface&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;DamageDealerOwner&lt;/Interface&gt;
</span></span><span style="display:flex;"><span>        &lt;Interface&gt;DebugDrawEntity&lt;/Interface&gt;
</span></span></code></pre></div><p>Okay, we actually are able to extract actual files!</p>
<p>&hellip;But without the names, it&rsquo;s not that interesting.</p>
<p>Note that in my &ldquo;brute-force deflate&rdquo; tool, I chose to name the files I managed to extract with the (approximate) corresponding start and end offsets of what my tool managed to uncompress (ex: <code>000A165D8C-000A16C774</code>, start offset is <code>000A165D8C</code>, end is <code>000A16C774</code>). This makes it simpler to correlate each extracted files to section in the original file.</p>
<p>Going back to the reverse engineering, that was progress, but I then lost I interest, and didn&rsquo;t follow-up for two years.</p>
<p>If I recall correctly I remember being discouraged by not being able to exploit the few 3D models/textures I managed to extract, so I left it as is for the time being.</p>
<h2 id="follow-up-effort">Follow-up effort</h2>
<h3 id="renewed-interest">Renewed interest</h3>
<p>Then, a few weeks ago, I 3D printed a <a href="https://www.thingiverse.com/thing:2479868">ship model from Thingiverse</a> clearly imported from WoWs, and posted the result on <a href="https://www.reddit.com/r/WorldOfWarships/comments/10ozv6y/i_might_have_accidentally_created_t11_petro_3d/">Reddit</a>.</p>
<p>In one of the comment, someone asked if it was possible to export other game models, which sparked my interest once again. FYI, a <a href="https://github.com/ShadowyBandit/.geometry-converter">plugin</a> to import WoWs .geometry (Big World game engin format) into Blender, but it doesn&rsquo;t look functional at the moment.</p>
<p>During the quick search, I also tried the Windows wows_unpack tool for the first time (I should really have started from there). This gave me some insights, in particular, the resource files having individual names and paths withing the .pkg files.</p>
<p>So, we are dealing with what is roughly a custom archive format (a bit like a zip file). This means we can probably expect the following things:</p>
<ul>
<li>a bunch of data blobs concatenated together, with the compressed data in these blobs.</li>
<li>an index with the file paths and some metadata containing possibly things like file types, file ids, offsets pointing to the correct data blob, checksums, etc.</li>
</ul>
<p>So let&rsquo;s take a look at the files again.</p>
<h3 id="investigating-the-pkg-files">Investigating the .pkg files</h3>
<p>First, I copied over a few of the game files into a dedicated <code>res_unpack</code> directory to avoid breaking my install by accident.</p>
<p>Then, let&rsquo;s stare at more hexdumps:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux World of Warships/res_unpack » hexdump -C system_data_0001.pkg | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>000021e0  b7 df f2 d7 ff e4 4f bd  <span style="color:#ae81ff">52</span> f6 <span style="color:#ae81ff">39</span> be f5 4a <span style="color:#ae81ff">92</span> 2f  |......O.R.9..J./|
</span></span><span style="display:flex;"><span>000021f0  d9 8a f4 ff <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> bf <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">45</span> 5c 6c <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">00</span>  |...........E<span style="color:#ae81ff">\l</span>6.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002200</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> dd <span style="color:#ae81ff">97</span> cf  6e e2 <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">10</span> c6 cf <span style="color:#ae81ff">54</span> ea  |........n.0...T.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002210</span>  3b <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">09</span> <span style="color:#ae81ff">09</span> <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">41</span> a5 <span style="color:#ae81ff">22</span> ca 9f <span style="color:#ae81ff">83</span> b7 <span style="color:#ae81ff">08</span>  |;Dy. .. A.<span style="color:#e6db74">&#34;.....|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002220  38 ec cd 72 93 61 6b 6d  6c 47 ce a4 85 b7 5f 3b  |8..r.akmlG...._;|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002230  25 0b 6d 29 d5 ae ba 12  9b 63 26 33 e3 df f7 79  |%.m).....c&amp;3...y|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002240  ec 28 03 26 b9 60 08 09  e1 79 9c 37 b7 22 bd b9  |.(.&amp;.`...y.7.&#34;</span>..|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002250</span>  be 6a 0c <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">13</span>  <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">74</span> c9 <span style="color:#ae81ff">82</span> de <span style="color:#ae81ff">92</span> 7e b7  |.j..yr$.0t....~.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002260</span>  <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">47</span> <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">48</span> e1 <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">80</span>  8e <span style="color:#ae81ff">55</span> fc <span style="color:#ae81ff">93</span> da <span style="color:#ae81ff">42</span> d7 <span style="color:#ae81ff">11</span>  |CG.xH....U...B..|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002270</span>  5c ce <span style="color:#ae81ff">93</span> <span style="color:#ae81ff">14</span> c6 <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">66</span> c8  <span style="color:#ae81ff">95</span> 1c ba <span style="color:#ae81ff">51</span> b3 6d a2 6c  |<span style="color:#ae81ff">\.</span>....f....Q.m.l|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002280</span>  fb 3a ea <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">26</span> 6c 3b <span style="color:#ae81ff">37</span>  <span style="color:#ae81ff">06</span> 2f 0b 9a e8 be 3f 6a  |.:..&amp;l;7./....?j|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002290</span>  <span style="color:#ae81ff">26</span> f3 8d d2 a6 <span style="color:#ae81ff">19</span> ee <span style="color:#ae81ff">32</span>  <span style="color:#ae81ff">13</span> e0 a6 <span style="color:#ae81ff">72</span> 9f db fa 9d  |&amp;......2...r....|
</span></span><span style="display:flex;"><span>000022a0  5c <span style="color:#ae81ff">52</span> b5 2c d6 <span style="color:#ae81ff">69</span> be a8  7b c4 c7 <span style="color:#ae81ff">25</span> c5 <span style="color:#ae81ff">42</span> 6b c0  |<span style="color:#ae81ff">\R</span>.,.i..<span style="color:#f92672">{</span>..%.Bk.|
</span></span><span style="display:flex;"><span>000022b0  8f <span style="color:#ae81ff">20</span> 7b a7 <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">43</span> <span style="color:#ae81ff">13</span> b6  eb da 7c <span style="color:#ae81ff">19</span> b3 8c c5 1c  |. <span style="color:#f92672">{</span>.!C....|.....|
</span></span><span style="display:flex;"><span>000022c0  ad <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">87</span> <span style="color:#ae81ff">94</span> a0 2a 3c fd  da <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">70</span> f2 <span style="color:#ae81ff">47</span> 9e 8d <span style="color:#ae81ff">81</span>  |.7...*&lt;..6p.G...|
</span></span><span style="display:flex;"><span>000022d0  e1 e3 dd <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">31</span> 0e dd  8c <span style="color:#ae81ff">69</span> e4 <span style="color:#ae81ff">71</span> 0a <span style="color:#ae81ff">79</span> 6b 0d  |...f.1...i.q.yk.|
</span></span><span style="display:flex;"><span>000022e0  <span style="color:#ae81ff">29</span> <span style="color:#ae81ff">64</span> 4a <span style="color:#ae81ff">23</span> 5d <span style="color:#ae81ff">57</span> a2 <span style="color:#ae81ff">41</span>  5b cf dd cf e4 <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">43</span> 7a  |<span style="color:#f92672">)</span>dJ#<span style="color:#f92672">]</span>W.A<span style="color:#f92672">[</span>....uCz|
</span></span><span style="display:flex;"><span>000022f0  9f <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">45</span> 4e <span style="color:#ae81ff">17</span> 9a 8b  f3 5b <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">46</span> dd 3f dd <span style="color:#ae81ff">82</span>  |.!.EN....<span style="color:#f92672">[</span>pF.?..|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002300</span>  de 1b c6 <span style="color:#ae81ff">75</span> 8d f6 <span style="color:#ae81ff">60</span> 4a  fc 5e 9f <span style="color:#ae81ff">12</span> f8 c1 <span style="color:#ae81ff">50</span> 2b  |...u..<span style="color:#e6db74">`</span>J.^....P+|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002310</span>  <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">71</span> f6 5b bc ce <span style="color:#ae81ff">01</span> af  4e ce 2f <span style="color:#ae81ff">49</span> d4 e9 d3 <span style="color:#ae81ff">65</span>  |yq.<span style="color:#f92672">[</span>....N./I...e|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002320</span>  <span style="color:#ae81ff">79</span> b8 2f ce <span style="color:#ae81ff">77</span> 0b <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">56</span>  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">72</span> 7d <span style="color:#ae81ff">44</span> fc b6 <span style="color:#ae81ff">17</span>  |y./.w..Vpur<span style="color:#f92672">}</span>D...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002330</span>  d2 <span style="color:#ae81ff">99</span> c2 a5 4a fe e6 c2  f7 be c0 f6 f7 b5 <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">35</span>  |....J.........65|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002340</span>  <span style="color:#ae81ff">78</span> 5f d7 <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">40</span> a9 7b 9f  <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">10</span> bf ca <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">51</span> a1  |x_..@.<span style="color:#f92672">{</span>.u...@.Q.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002350</span>  ad 8a b7 <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">09</span> a4 6c  b7 <span style="color:#ae81ff">82</span> <span style="color:#ae81ff">78</span> e8 fa 4d 2f <span style="color:#ae81ff">74</span>  |....8..l..x..M/t|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002360</span>  1d a9 <span style="color:#ae81ff">12</span> f8 <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">98</span> 2d  e8 e4 3b <span style="color:#ae81ff">25</span> e6 <span style="color:#ae81ff">34</span> f1 2d  |....Vv.-..;%.4.-|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002370</span>  7d f1 d4 6d fd d1 <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">94</span>  <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">95</span> <span style="color:#ae81ff">81</span> <span style="color:#ae81ff">75</span> 1a 8d <span style="color:#ae81ff">09</span>  |<span style="color:#f92672">}</span>..m..d..F..u...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002380</span>  f1 <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">80</span> 4e cd <span style="color:#ae81ff">15</span> 9f da  b1 <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">37</span> 1b dd d3 c2 3a  |...N.....87....:|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002390</span>  5f <span style="color:#ae81ff">30</span> 1b <span style="color:#ae81ff">67</span> f1 c2 <span style="color:#ae81ff">03</span> 5e  9d 9c 9f <span style="color:#ae81ff">13</span> 3f 6a d3 <span style="color:#ae81ff">95</span>  |_0.g...^....?j..|
</span></span><span style="display:flex;"><span>000023a0  2a <span style="color:#ae81ff">64</span> f2 cc 9e 2e ef <span style="color:#ae81ff">36</span>  b4 7c de <span style="color:#ae81ff">11</span> 5f 9d bc 9f  |*d.....6.|.._...|
</span></span><span style="display:flex;"><span>000023b0  <span style="color:#ae81ff">92</span> a0 6d bc <span style="color:#ae81ff">47</span> a6 f3 <span style="color:#ae81ff">58</span>  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">37</span> f7 <span style="color:#ae81ff">16</span> d0 3b  |..m.G..X...7...;|
</span></span><span style="display:flex;"><span>000023c0  <span style="color:#ae81ff">06</span> 1c <span style="color:#ae81ff">31</span> <span style="color:#ae81ff">44</span> f3 <span style="color:#ae81ff">55</span> fa 2f  dd af <span style="color:#ae81ff">44</span> bf fe 2f f9 <span style="color:#ae81ff">05</span>  |..1D.U./..D../..|
</span></span><span style="display:flex;"><span>000023d0  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 6d b9 de c1  ad 0c <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |....m...........|
</span></span><span style="display:flex;"><span>000023e0  7d cf cd 0d <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">20</span> 0c <span style="color:#ae81ff">80</span>  d1 b3 <span style="color:#ae81ff">26</span> ce c2 <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">84</span> 8b  |<span style="color:#f92672">}</span>.... ....&amp;.....|
</span></span><span style="display:flex;"><span>000023f0  c6 <span style="color:#ae81ff">01</span> dc <span style="color:#ae81ff">00</span> b5 fe <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">85</span>  <span style="color:#ae81ff">12</span> 5a f6 <span style="color:#ae81ff">57</span> 8c <span style="color:#ae81ff">92</span> <span style="color:#ae81ff">70</span> f1  |......$..Z.W..p.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002400</span>  f8 b5 ef d0 ea <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">24</span> a6  6b 1b 0d de ce <span style="color:#ae81ff">08</span> ab <span style="color:#ae81ff">19</span>  |.....H$.k.......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002410</span>  2d <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">68</span> f5 e5 b3 <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">70</span>  e0 <span style="color:#ae81ff">85</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">94</span> <span style="color:#ae81ff">32</span> 5b 4c 2c  |-2h...Bp..s.2<span style="color:#f92672">[</span>L,|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002420</span>  c9 f5 <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">86</span> 9b bf c3 4a  2c e4 <span style="color:#ae81ff">82</span> <span style="color:#ae81ff">65</span> fe <span style="color:#ae81ff">11</span> 7c 9c  |..x....J,..e..|.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002430</span>  <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">20</span> c4 1f b2 <span style="color:#ae81ff">27</span> 3f <span style="color:#ae81ff">91</span>  <span style="color:#ae81ff">58</span> a1 <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">57</span> aa <span style="color:#ae81ff">44</span> 3e  |a ...<span style="color:#960050;background-color:#1e0010">&#39;</span>?.X...W.D&gt;|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002440</span>  4d ab e7 <span style="color:#ae81ff">97</span> 0b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> f1 d2 <span style="color:#ae81ff">87</span> 5a d2 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |M...........Z...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002450</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ad 9c db  6e db b8 <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">86</span> af <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">03</span>  |........n.....g.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002460</span>  fb 1d 3c b9 2f 3a 3e e4  <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">20</span> 0d c0 <span style="color:#ae81ff">48</span> 8c ad <span style="color:#ae81ff">89</span>  |..&lt;./:&gt;.P ..H...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002470</span>  2c <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">28</span> c9 4e 7a <span style="color:#ae81ff">23</span> b8  <span style="color:#ae81ff">89</span> 3b <span style="color:#ae81ff">35</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">89</span> <span style="color:#ae81ff">03</span> c7 <span style="color:#ae81ff">99</span>  |,i<span style="color:#f92672">(</span>.Nz#..;5&amp;....|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002480</span>  ee be fd <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">29</span> 2e  <span style="color:#ae81ff">52</span> 4b <span style="color:#ae81ff">72</span> 2f 0a a4 <span style="color:#ae81ff">16</span> fd  |...&amp;u2<span style="color:#f92672">)</span>.RKr/....|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002490</span>  7f bf <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">69</span> f1 e4 cb  d7 dd fa 6d bd bf fa ef  |..<span style="color:#f92672">(</span>ri......m....|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>I noticed the 128 bits pattern <code>00 00 00 00 | xx xx xx xx | xx xx 00 00 | 00 00 00 00</code> repeating within the file (<code>|</code> used to cut every 32 bits).</p>
<p>The starts and end of these small sections line-up pretty well with the data sections I managed to extract:</p>
<pre tabindex="0"><code>0000000001-00000021F6
0000002206-00000023D1
00000023E1-0000002446
0000002456-00000031C8
</code></pre><p>We indeed have the first <code>00 00 [...]</code> pattern staring at offset 000021f4 and ending 00002205 which nearly matches 00000021F6 (end of first extracted file) and 0000002206 (start of second extracted file).
The next pattern starts at 000023d0 and ends at 000023df, which again lines-up roughly with 00000023D1 and 00000023E1. And so on for all the sections.</p>
<p>Note, my brute-force tool is most likely a bit buggy and probably adds a few +1 offsets here and there, also it is likely that the uncompressions overflows a bit beyond the actual compressed data. But it is good enough for purpose.</p>
<p>Looking at the end of the file, we have this pattern repeating one final time at the very end:</p>
<pre tabindex="0"><code>0a16d3c0  79 b0 e2 a0 8e e3 a8 3c  4b d5 d4 51 a0 7b b2 a1  |y......&lt;K..Q.{..|
0a16d3d0  32 6b 36 bf fc ce 46 b6  1e d6 2d b8 94 98 ea 74  |2k6...F...-....t|
0a16d3e0  ac 57 92 19 a0 2f 7a c5  43 23 1e 46 0e 1d a8 6f  |.W.../z.C#.F...o|
0a16d3f0  9a fe f2 85 0e 6c 2f a4  8b 87 71 d4 5e 9a 8f d4  |.....l/...q.^...|
0a16d400  41 0f eb 85 aa b4 41 f7  ab af 86 39 6a d7 db af  |A.....A....9j...|
0a16d410  2a 24 8b 8f 8d 7f 6a f6  3f 00 00 00 00 6b ba c9  |*$....j.?....k..|
0a16d420  70 eb 6c 00 00 00 00 00  00                       |p.l......|
0a16d429
(END)
</code></pre><p>Further more, the first uncompressed block seems to start right at the begining of the file, so there is probably no header section.</p>
<h3 id="general-format-of-the-pkg-file">General format of the .pkg file</h3>
<p>Looking at a few other <code>.pkg</code>, this pattern seems to be shared accross all files.</p>
<p>So we can deduce the format <code>.pkg</code> is a concatenated list of sections like the following:</p>
<pre tabindex="0"><code>+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+
|                                                                                             |
|                             Compressed Data (RFC 1951/Deflate)                              |
|                                                                                             |
+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+
+====++====++====++====++====++====++====++====+====++====++====++====++====++====++====++====+
| 00 || 00 || 00 || 00 || XX || XX || XX || XX | XX || XX || 00 || 00 || 00 || 00 || 00 || 00 |
+====++====++====++====++====++====++====++====+====++====++====++====++====++====++====++====+
|&lt;----- 0 padding ----&gt;||&lt;----------- some kind of ID ---------------&gt;||&lt;---- 0 padding -----&gt;|
</code></pre><p>Note that by this point, I&rsquo;m making a lot of assumptions:</p>
<ul>
<li>I&rsquo;m assuming that <code>0 padding</code> 32 bits blocks are actually padding, but they could be fields which happened to be set to 0 most of the time</li>
<li>I&rsquo;m a bit puzzled by the 16 bits  <code>00 00</code> at the end of <code>some kind of ID</code></li>
<li>I&rsquo;m also not completely sure if the block containing the data is always compressed using Deflate</li>
<li>I&rsquo;m not even sure if this general file format is actually shared across all files.</li>
</ul>
<p>But let&rsquo;s go forward, this format seems common enough to still yeild good results. Plus we can always go back and revisit this interpretation.</p>
<h3 id="what-the-id-might-be">What the ID might be</h3>
<p>Let&rsquo;s take a look at some of these:</p>
<pre tabindex="0"><code>00 00 00 00 | bf 00 45 5c | 6c 36 00 00 | 00 00 00 00
00 00 00 00 | 6d b9 de c1 | ad 0c 00 00 | 00 00 00 00
00 00 00 00 | f1 d2 87 5a | d2 00 00 00 | 00 00 00 00
00 00 00 00 | 83 0a 72 88 | a3 5c 00 00 | 00 00 00 00
00 00 00 00 | 92 ab 31 63 | 91 2a 00 00 | 00 00 00 00
</code></pre><p>So looking at these &ldquo;IDs&rdquo;, here are the things to note:</p>
<ul>
<li>they are rather random and high value, meaning they probably don&rsquo;t represent offsets.</li>
<li>they look too short (~48 bits) for any <a href="https://en.wikipedia.org/wiki/List_of_hash_functions">hash algorithm</a>.</li>
<li>their fix size doesn&rsquo;t indicate it&rsquo;s some kind of compressed data.</li>
</ul>
<p>So they are probably just&hellip; well&hellip; random IDs.</p>
<p>Also, it means that <code>.pkg</code> files only contains the raw resource files bundled together. All the meta data associated with these files, most importantly their names are contained elsewhere.</p>
<h3 id="looking-for-the-files-metadata">Looking for the files metadata</h3>
<p>So it&rsquo;s back to looking at the game files. Hopefully the resources metadata are not embedded directly in the WoWs executable or one of its library.</p>
<p>Let&rsquo;s look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># List all files</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># then remove uninteresting bits like replays, crash, dlls, logs, .pkg or cef stuff (embedded Chrome used for the armory, inventory dockyard and clan base))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kakwa@linux Games/World of Warships » find ./ -type f | grep -v cef | grep -v replays | grep -v crashes | grep -v <span style="color:#e6db74">&#39;.pkg&#39;</span> | grep -v <span style="color:#e6db74">&#39;.dll&#39;</span> | grep -v <span style="color:#e6db74">&#39;.log&#39;</span>  | grep -v <span style="color:#e6db74">&#39;\.exe&#39;</span> | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/pl/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/zh_tw/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/fr/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/nl/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/th/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/es/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/ru/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/zh/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/ja/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/en/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/de/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/es_mx/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/texts/zh_sg/LC_MESSAGES/global.mo
</span></span><span style="display:flex;"><span>./bin/6775398/res/camerasConsumer.xml
</span></span><span style="display:flex;"><span>./bin/6775398/bin32/paths.xml
</span></span><span style="display:flex;"><span>./bin/6775398/bin32/Licenses.txt
</span></span><span style="display:flex;"><span>./bin/6775398/bin32/monitor_config.json
</span></span><span style="display:flex;"><span>./bin/6775398/bin64/paths.xml
</span></span><span style="display:flex;"><span>./bin/6775398/bin64/Licenses.txt
</span></span><span style="display:flex;"><span>./bin/6775398/bin64/monitor_config.json
</span></span><span style="display:flex;"><span>./bin/6775398/idx/spaces_dock_dry.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/vehicles_pve.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/vehicles_level8_fr.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/spaces_ocean.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/vehicles_level8_panasia.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/vehicles_level9_ned.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/vehicles_level5_panasia.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/spaces_sea_hope.idx
</span></span><span style="display:flex;"><span>./bin/6775398/idx/spaces_dock_hsf.idx
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Ohhh, these <code>.idx</code> files look promissing, specially their names match quite well the pkg files:</p>
<pre tabindex="0"><code>spaces_dock_hsf.idx -&gt; spaces_dock_hsf_0001.pkg
ehicles_level9_ned.idx -&gt; vehicles_level9_ned_0001.pkg
etc
</code></pre><p>Let&rsquo;s take a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux bin/6775398/idx » strings -n <span style="color:#ae81ff">5</span> system_data.idx
</span></span><span style="display:flex;"><span><span style="color:#75715e">#%B&#39;E</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#%B&#39;E</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#%B&#39;E</span>
</span></span><span style="display:flex;"><span>E<span style="color:#f92672">)</span>zj<span style="color:#e6db74">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FM&#39;</span>lb
</span></span><span style="display:flex;"><span>%<span style="color:#f92672">}</span>n:b
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>	?A+
</span></span><span style="display:flex;"><span>c|<span style="color:#e6db74">&#39;lY
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">zc78&#39;</span>
</span></span><span style="display:flex;"><span>tKDStorage.bin
</span></span><span style="display:flex;"><span>waves_heights1.dds
</span></span><span style="display:flex;"><span>animatedMiscs.xml
</span></span><span style="display:flex;"><span>LowerDeck.dds
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>maps
</span></span><span style="display:flex;"><span>helpers
</span></span><span style="display:flex;"><span>FoamMapLowFreq.dds
</span></span><span style="display:flex;"><span>tritanopia.dds
</span></span><span style="display:flex;"><span>color_correct_default.dds
</span></span><span style="display:flex;"><span>Color.dds
</span></span><span style="display:flex;"><span>Shimmer.dds
</span></span><span style="display:flex;"><span>highlight_noise.dds
</span></span><span style="display:flex;"><span>space_variation_dummy.dds
</span></span><span style="display:flex;"><span>waves_heights0.dds
</span></span><span style="display:flex;"><span>4F$<span style="color:#f92672">)</span>p
</span></span><span style="display:flex;"><span>E<span style="color:#f92672">)</span>zjp
</span></span><span style="display:flex;"><span> |5*y
</span></span><span style="display:flex;"><span>FM<span style="color:#e6db74">&#39;lp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">k4|W8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">%}n:p
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(	?A+
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">c|&#39;</span>lp
</span></span><span style="display:flex;"><span>LrL<span style="color:#f92672">)</span>t
</span></span><span style="display:flex;"><span>atw|$
</span></span><span style="display:flex;"><span>:M+Xp
</span></span><span style="display:flex;"><span>F?mep
</span></span><span style="display:flex;"><span>wsystem_data_0001.pkg
</span></span></code></pre></div><p>Bingo, we have all the file names, and at the end, the name of the corresponding <code>.pkg</code> file.</p>
<p>These <code>.idx</code> files, as the extension indicates, are our indexes containing all the file names and metadata.</p>
<p>Also, note that we have a few names (like <code>maps</code> or <code>helpers</code>) without extensions, these are probably directory names.</p>
<h3 id="bin-directory-and-game-versions">bin directory and Game versions</h3>
<p>There are a few things to note about the <code>./bin</code> directory: it contains several sub-directory looking like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux World of Warships/bin » du -hd <span style="color:#ae81ff">1</span> | sort -h
</span></span><span style="display:flex;"><span>12K	./5241351
</span></span><span style="display:flex;"><span>12K	./5315992
</span></span><span style="display:flex;"><span>12K	./5343985
</span></span><span style="display:flex;"><span>12K	./5450485
</span></span><span style="display:flex;"><span>12K	./5624555
</span></span><span style="display:flex;"><span>12K	./5771708
</span></span><span style="display:flex;"><span>12K	./5915585
</span></span><span style="display:flex;"><span>12K	./6081105
</span></span><span style="display:flex;"><span>12K	./6223574
</span></span><span style="display:flex;"><span>592M	./6623042
</span></span><span style="display:flex;"><span>594M	./6775398
</span></span></code></pre></div><p>This look a lot like incrementa build numbers, with WoWs keeping the latest published build &lsquo;N&rsquo; and &lsquo;N-1&rsquo; (the mostly empty directories are only containing left overs like logs or mods).</p>
<p>We will need to take this into account, using the highest numbered sub-directory to get the most up to date indexes.</p>
<h3 id="index-idx-general-layout">Index (.idx) general layout</h3>
<p>So next, lets look at one of these index files.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx | less
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">91</span> 9d <span style="color:#ae81ff">39</span> b4 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP......9.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 1c <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |7...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  f6 3b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>........;......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  0e <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |6q..............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000040</span>  e0 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  8f 0c 9a ba 4f <span style="color:#ae81ff">40</span> b6 <span style="color:#ae81ff">93</span>  |.&amp;..........O@..|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000050</span>  <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db  <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#e6db74">&#39;...............|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000060  ce 26 00 00 00 00 00 00  8f ec 87 4a 28 d0 f7 c7  |.&amp;.........J(...|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000070  a4 eb 1b 3e 50 21 d8 74  12 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000080  c1 26 00 00 00 00 00 00  ad 70 a2 e7 ac 2c 4f 6b  |.&amp;.......p...,Ok|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000090  27 b9 08 b1 d1 a1 b1 db  0e 00 00 00 00 00 00 00  |&#39;</span>...............|
</span></span><span style="display:flex;"><span>000000a0  b3 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  4e <span style="color:#ae81ff">84</span> a5 6a <span style="color:#ae81ff">94</span> dc 1f 7f  |.&amp;......N..j....|
</span></span><span style="display:flex;"><span>000000b0  <span style="color:#ae81ff">62</span> f5 aa 4b 5e <span style="color:#ae81ff">15</span> 7f <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |b..K^...........|
</span></span><span style="display:flex;"><span>000000c0  a1 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  4e b0 fe <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">40</span> a5 <span style="color:#ae81ff">65</span>  |.&amp;......N..#b@.e|
</span></span><span style="display:flex;"><span>000000d0  <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db  <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#e6db74">&#39;....... .......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000000e0  91 26 00 00 00 00 00 00  8e c7 6a 58 7c 86 62 33  |.&amp;........jX|.b3|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000000f0  27 b9 08 b1 d1 a1 b1 db  0f 00 00 00 00 00 00 00  |&#39;</span>...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000100</span>  <span style="color:#ae81ff">91</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  8e <span style="color:#ae81ff">43</span> 3d e9 cf <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">52</span> a4  |.&amp;.......C<span style="color:#f92672">=</span>..IR.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000110</span>  <span style="color:#ae81ff">62</span> f5 aa 4b 5e <span style="color:#ae81ff">15</span> 7f <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |b..K^...........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000120</span>  <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  0e 3c 9a 6d <span style="color:#ae81ff">22</span> de 7b da  |.&amp;.......&lt;.m<span style="color:#e6db74">&#34;.{.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000130  4e b0 fe 23 62 40 a5 65  0b 00 00 00 00 00 00 00  |N..#b@.e........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000140  76 26 00 00 00 00 00 00  0e 48 58 ea 50 44 1a 47  |v&amp;.......HX.PD.G|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000150  df 61 50 67 c7 3a dd 7a  13 00 00 00 00 00 00 00  |.aPg.:.z........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000160  61 26 00 00 00 00 00 00  e0 9f c3 bd d2 12 20 04  |a&amp;............ .|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000170  09 28 f1 df 2d 04 93 de  0b 00 00 00 00 00 00 00  |.(..-...........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000180  54 26 00 00 00 00 00 00  e0 95 53 f6 cc 08 c0 46  |T&amp;........S....F|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000190  06 cf 85 bd 69 99 e2 46  0d 00 00 00 00 00 00 00  |....i..F........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000001a0  3f 26 00 00 00 00 00 00  e0 99 68 5e 2d 70 13 72  |?&amp;........h^-p.r|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000001b0  4c d1 2e 30 73 38 d9 13  10 00 00 00 00 00 00 00  |L..0s8..........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002660  53 15 00 00 00 00 00 00  a4 eb 1b 3e 50 21 d8 74  |S..........&gt;P!.t|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002670  38 e6 83 3c 74 a7 20 b2  0a 00 00 00 00 00 00 00  |8..&lt;t. .........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002680  37 15 00 00 00 00 00 00  e7 c6 0b ae d5 31 51 55  |7............1QU|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002690  a4 eb 1b 3e 50 21 d8 74  0c 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026a0  21 15 00 00 00 00 00 00  00 40 cc c7 49 c4 54 09  |!........@..I.T.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026b0  a4 eb 1b 3e 50 21 d8 74  14 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026c0  0d 15 00 00 00 00 00 00  ce 6a 28 bc cf e7 79 c8  |.........j(...y.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026d0  a4 eb 1b 3e 50 21 d8 74  1a 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026e0  01 15 00 00 00 00 00 00  6c c0 c9 f7 7e 00 03 05  |........l...~...|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026f0  a4 eb 1b 3e 50 21 d8 74  13 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002700  fb 14 00 00 00 00 00 00  74 d1 1b 8d f4 ff 7a ce  |........t.....z.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002710  a4 eb 1b 3e 50 21 d8 74  4b 44 53 74 6f 72 61 67  |...&gt;P!.tKDStorag|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002720  65 2e 62 69 6e 00 77 61  76 65 73 5f 68 65 69 67  |e.bin.waves_heig|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002730  68 74 73 31 2e 64 64 73  00 61 6e 69 6d 61 74 65  |hts1.dds.animate|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002740  64 4d 69 73 63 73 2e 78  6d 6c 00 4c 6f 77 65 72  |dMiscs.xml.Lower|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002750  44 65 63 6b 2e 64 64 73  00 63 6f 6d 6d 61 6e 64  |Deck.dds.command|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002760  5f 6d 61 70 70 69 6e 67  00 61 75 74 6f 74 65 73  |_mapping.autotes|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002770  74 73 5f 64 72 61 77 5f  67 75 69 5f 73 65 74 74  |ts_draw_gui_sett|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002780  69 6e 67 73 2e 78 6d 6c  00 48 6f 75 73 65 46 72  |ings.xml.HouseFr|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002790  6f 6e 74 2e 64 64 73 00  70 72 65 73 65 74 5f 6b  |ont.dds.preset_k|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027a0  65 79 62 6f 61 72 64 5f  31 2e 78 6d 6c 00 69 6e  |eyboard_1.xml.in|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027b0  74 65 72 66 61 63 65 73  00 76 65 72 64 61 6e 61  |terfaces.verdana|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027c0  5f 73 6d 61 6c 6c 2e 66  6f 6e 74 00 73 70 61 63  |_small.font.spac|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027d0  65 5f 64 65 66 73 00 61  69 64 5f 6e 75 6c 6c 2e  |e_defs.aid_null.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027e0  64 64 73 00 63 61 6d 6f  75 66 6c 61 67 65 73 2e  |dds.camouflages.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000027f0  78 6d 6c 00 63 68 75 6e  6b 2e 64 64 73 00 66 6f  |xml.chunk.dds.fo|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002800  6e 74 63 6f 6e 66 69 67  2e 78 6d 6c 00 46 6f 61  |ntconfig.xml.Foa|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002810  6d 4d 61 70 2e 64 64 73  00 42 75 69 6c 64 69 6e  |mMap.dds.Buildin|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002820  67 2e 64 65 66 00 63 6f  6e 66 69 67 2e 78 6d 6c  |g.def.config.xml|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002830  00 67 61 6d 65 5f 77 69  6e 64 5f 6e 6f 69 73 65  |.game_wind_noise|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002840  2e 64 64 73 00 47 61 6d  65 50 61 72 61 6d 73 2e  |.dds.GameParams.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002850  64 61 74 61 00 44 65 62  75 67 44 72 61 77 45 6e  |data.DebugDrawEn|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002860  74 69 74 79 2e 64 65 66  00 63 6f 6e 74 65 6e 74  |tity.def.content|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002870  00 4c 6f 77 65 72 46 6f  72 77 61 72 64 54 72 61  |.LowerForwardTra|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002880  6e 73 2e 64 64 73 00 55  49 50 61 72 61 6d 73 2e  |ns.dds.UIParams.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003bc0  2e 64 64 73 00 68 69 67  68 6c 69 67 68 74 5f 6e  |.dds.highlight_n|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003bd0  6f 69 73 65 2e 64 64 73  00 73 70 61 63 65 5f 76  |oise.dds.space_v|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003be0  61 72 69 61 74 69 6f 6e  5f 64 75 6d 6d 79 2e 64  |ariation_dummy.d|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003bf0  64 73 00 77 61 76 65 73  5f 68 65 69 67 68 74 73  |ds.waves_heights|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c00  30 2e 64 64 73 00 8f 0c  9a ba 4f 40 b6 93 70 11  |0.dds.....O@..p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c10  03 07 0d 33 ed 77 00 00  00 00 00 00 00 00 05 00  |...3.w..........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c20  00 00 01 00 00 00 f5 21  00 00 bf 00 45 5c 6c 36  |.......!....E\l6|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c30  00 00 00 00 00 00 8f ec  87 4a 28 d0 f7 c7 70 11  |.........J(...p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c40  03 07 0d 33 ed 77 1e 9b  ef 05 00 00 00 00 05 00  |...3.w..........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c50  00 00 01 00 00 00 15 15  01 00 03 77 63 97 3e ab  |...........wc.&gt;.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c60  02 00 00 00 00 00 ad 70  a2 e7 ac 2c 4f 6b 70 11  |.......p...,Okp.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c70  03 07 0d 33 ed 77 05 22  00 00 00 00 00 00 05 00  |...3.w.&#34;</span>........|
</span></span><span style="display:flex;"><span>00003c80  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> cb <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 6d b9 de c1 ad 0c  |..........m.....|
</span></span><span style="display:flex;"><span>00003c90  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 8e c7  6a <span style="color:#ae81ff">58</span> 7c <span style="color:#ae81ff">86</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |........jX|.b3p.|
</span></span><span style="display:flex;"><span>00003ca0  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> e0 <span style="color:#ae81ff">23</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w.#........|
</span></span><span style="display:flex;"><span>00003cb0  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f1 d2 <span style="color:#ae81ff">87</span> 5a d2 <span style="color:#ae81ff">00</span>  |......e......Z..|
</span></span><span style="display:flex;"><span>00003cc0  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 8e <span style="color:#ae81ff">43</span>  3d e9 cf <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">52</span> a4 <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.......C<span style="color:#f92672">=</span>..IR.p.|
</span></span><span style="display:flex;"><span>00003cd0  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> 4d 1f  6a <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.wM.j.......|
</span></span><span style="display:flex;"><span>00003ce0  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> bb <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f7 <span style="color:#ae81ff">53</span> 4a b1 <span style="color:#ae81ff">38</span> ab  |...........SJ.8.|
</span></span><span style="display:flex;"><span>00003cf0  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 0e 3c  9a 6d <span style="color:#ae81ff">22</span> de 7b da <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.......&lt;.m<span style="color:#e6db74">&#34;.{.p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003d00  03 07 0d 33 ed 77 55 24  00 00 00 00 00 00 05 00  |...3.wU</span>$<span style="color:#e6db74">........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070a0  00 00 01 00 00 00 90 24  00 00 62 c1 d9 06 f8 d8  |.......</span>$<span style="color:#e6db74">..b.....|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070b0  00 00 00 00 00 00 57 b3  82 06 56 f0 2a e6 70 11  |......W...V.*.p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070c0  03 07 0d 33 ed 77 ea cc  15 0a 00 00 00 00 05 00  |...3.w..........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070d0  00 00 01 00 00 00 7c 01  00 00 84 a8 12 1d 61 04  |......|.......a.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070e0  00 00 00 00 00 00 57 64  91 29 c9 3c f0 96 70 11  |......Wd.).&lt;..p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000070f0  03 07 0d 33 ed 77 a9 ef  15 0a 00 00 00 00 05 00  |...3.w..........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007100  00 00 01 00 00 00 6f 09  00 00 fc 56 94 f8 9a 37  |......o....V...7|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007110  00 00 00 00 00 00 21 67  ac 70 22 ec ca b8 70 11  |......!g.p&#34;</span>...p.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007120</span>  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">28</span> f9  <span style="color:#ae81ff">15</span> 0a <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w<span style="color:#f92672">(</span>.........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007130</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 0b 2d  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">03</span> bd b0 <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">67</span> e9  |.......-.....Pg.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007140</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007150</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">79</span>  |......p....3.wsy|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007160</span>  <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">65</span> 6d 5f <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">61</span> 5f <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">31</span> 2e <span style="color:#ae81ff">70</span>  |stem_data_0001.p|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007170</span>  6b <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">00</span>                                          |kg.|
</span></span></code></pre></div><p>The general layout of the file appears to be at least in 3 chunks:</p>
<ul>
<li>A first chunk of metadata</li>
<li>A all the file name strings <code>\0</code> separated, but also a few strings without extensions, probably directory names.</li>
<li>A second chunk of metadata</li>
</ul>
<p>Lets look for the IDs we found in the corresponding <code>.pkg</code> (here <code>system_data_0001.pkg</code>), for example <code>00 00 00 00 | bf 00 45 5c | 6c 36 00 00 | 00 00 00 00</code>.</p>
<pre tabindex="0"><code>[......................] 00 8f 0c  9a ba 4f 40 b6 93 70 11  |0.dds.....O@..p.|
00003c10  03 07 0d 33 ed 77 00 00  00 00 00 00 00 00 05 00  |...3.w..........|
00003c20  00 00 01 00 00 00 f5 21  00 00 bf 00 45 5c 6c 36  |.......!....E\l6|
00003c30  00 00 00 00 00 00 8f ec [...]
</code></pre><p>Ok, it&rsquo;s there, in the second chunk. And it also works if we test for other IDs. We have at least a link by ID between the <code>.idx</code> and the <code>.pkg</code> file.</p>
<p>We will come back later to the second chunk, remembering that, but lets focus on the first chunk for now.</p>
<h3 id="format-of-the-first-metadata-chunk-of-the-idx-file">Format of the first metadata chunk of the &lsquo;.idx&rsquo; file</h3>
<p>Lets try to understand the first part of the .idx file structure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx | less
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">91</span> 9d <span style="color:#ae81ff">39</span> b4 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP......9.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 1c <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |7...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  f6 3b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>........;......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  0e <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |6q..............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000040</span>  e0 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  8f 0c 9a ba 4f <span style="color:#ae81ff">40</span> b6 <span style="color:#ae81ff">93</span>  |.&amp;..........O@..|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000050</span>  <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db  <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#e6db74">&#39;...............|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000060  ce 26 00 00 00 00 00 00  8f ec 87 4a 28 d0 f7 c7  |.&amp;.........J(...|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000070  a4 eb 1b 3e 50 21 d8 74  12 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000080  c1 26 00 00 00 00 00 00  ad 70 a2 e7 ac 2c 4f 6b  |.&amp;.......p...,Ok|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000090  27 b9 08 b1 d1 a1 b1 db  0e 00 00 00 00 00 00 00  |&#39;</span>...............|
</span></span><span style="display:flex;"><span>000000a0  b3 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  4e <span style="color:#ae81ff">84</span> a5 6a <span style="color:#ae81ff">94</span> dc 1f 7f  |.&amp;......N..j....|
</span></span><span style="display:flex;"><span>000000b0  <span style="color:#ae81ff">62</span> f5 aa 4b 5e <span style="color:#ae81ff">15</span> 7f <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |b..K^...........|
</span></span><span style="display:flex;"><span>000000c0  a1 <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  4e b0 fe <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">40</span> a5 <span style="color:#ae81ff">65</span>  |.&amp;......N..#b@.e|
</span></span><span style="display:flex;"><span>000000d0  <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db  <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#e6db74">&#39;....... .......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000000e0  91 26 00 00 00 00 00 00  8e c7 6a 58 7c 86 62 33  |.&amp;........jX|.b3|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000000f0  27 b9 08 b1 d1 a1 b1 db  0f 00 00 00 00 00 00 00  |&#39;</span>...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000100</span>  <span style="color:#ae81ff">91</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  8e <span style="color:#ae81ff">43</span> 3d e9 cf <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">52</span> a4  |.&amp;.......C<span style="color:#f92672">=</span>..IR.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000110</span>  <span style="color:#ae81ff">62</span> f5 aa 4b 5e <span style="color:#ae81ff">15</span> 7f <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |b..K^...........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000120</span>  <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">26</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  0e 3c 9a 6d <span style="color:#ae81ff">22</span> de 7b da  |.&amp;.......&lt;.m<span style="color:#e6db74">&#34;.{.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000130  4e b0 fe 23 62 40 a5 65  0b 00 00 00 00 00 00 00  |N..#b@.e........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000140  76 26 00 00 00 00 00 00  0e 48 58 ea 50 44 1a 47  |v&amp;.......HX.PD.G|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000150  df 61 50 67 c7 3a dd 7a  13 00 00 00 00 00 00 00  |.aPg.:.z........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000160  61 26 00 00 00 00 00 00  e0 9f c3 bd d2 12 20 04  |a&amp;............ .|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000170  09 28 f1 df 2d 04 93 de  0b 00 00 00 00 00 00 00  |.(..-...........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002690  a4 eb 1b 3e 50 21 d8 74  0c 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026a0  21 15 00 00 00 00 00 00  00 40 cc c7 49 c4 54 09  |!........@..I.T.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026b0  a4 eb 1b 3e 50 21 d8 74  14 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026c0  0d 15 00 00 00 00 00 00  ce 6a 28 bc cf e7 79 c8  |.........j(...y.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026d0  a4 eb 1b 3e 50 21 d8 74  1a 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026e0  01 15 00 00 00 00 00 00  6c c0 c9 f7 7e 00 03 05  |........l...~...|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">000026f0  a4 eb 1b 3e 50 21 d8 74  13 00 00 00 00 00 00 00  |...&gt;P!.t........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002700  fb 14 00 00 00 00 00 00  74 d1 1b 8d f4 ff 7a ce  |........t.....z.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002710  a4 eb 1b 3e 50 21 d8 74  4b 44 53 74 6f 72 61 67  |...&gt;P!.tKDStorag|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002720  65 2e 62 69 6e 00 77 61  76 65 73 5f 68 65 69 67  |e.bin.waves_heig|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002730  68 74 73 31 2e 64 64 73  00 61 6e 69 6d 61 74 65  |hts1.dds.animate|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002740  64 4d 69 73 63 73 2e 78  6d 6c 00 4c 6f 77 65 72  |dMiscs.xml.Lower|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00002750  44 65 63 6b 2e 64 64 73  00 63 6f 6d 6d 61 6e 64  |Deck.dds.command|
</span></span></span></code></pre></div><p>Staring at the hexdump long enough and we can start to see some patterns.</p>
<p>At regular interval, every 256 bits, we get a 64 bits integer with a relatively low value, hinting at individual metadata sets of 256 bits.</p>
<p>This look suspeciously like some kind of constant enum coded into a 64 bits integer.
My best guess right now would be some kind of file type code, itself define as a constant in the game engine like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define FILE_TYPE_1 0x01
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILE_TYPE_2 0x02
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">// [...]
</span></span></span></code></pre></div><p>Let&rsquo;s call it <code>file_type</code> for now.</p>
<p>Looking at the end of the first chunk (right before we get <code>KDStorage.bin</code>), we have to go back 4 x 64 bits to get something that looks like a <code>file_type</code>.</p>
<p>This means <code>file_type</code> is the first field in the 256 bits structure.</p>
<p>Let&rsquo;s look at the next 64 bits: <code>ce 26 00 00 00 00 00 00</code>, <code>c1 26 00 00 00 00 00 00</code>, <code>80 26 00 00 00 00 00 00</code>, etc. These values are again rather small.</p>
<p>Also these values, at least for the first ones, are suspeciously close to <code>00002718</code>, e.i right where the section containing the file names starts.</p>
<p>The last ones, <code>01 15 00 00 00 00 00 00</code>, <code>fb 14 00 00 00 00 00 00</code>, etc, are smaller, and suspiciously, they have similar value to the lenght of the file name section (approximately <code>0x00003c00 - 0x00002710 = 0x0000014f0</code>).</p>
<p>The second field is then probably some kind of offset. Most likely from the start of one 256 bits chunk to the start of one of the file names.</p>
<p>Looking at other <code>.idx</code> files seems to confirm that.</p>
<p>Let&rsquo;s call it <code>offset</code> for now.</p>
<p>Next, let&rsquo;s look at the remaining 128 bits.</p>
<pre tabindex="0"><code>8f 0c 9a ba 4f 40 b6 93 | 27 b9 08 b1 d1 a1 b1 db
8f ec 87 4a 28 d0 f7 c7 | a4 eb 1b 3e 50 21 d8 74
ad 70 a2 e7 ac 2c 4f 6b | 27 b9 08 b1 d1 a1 b1 db
4e 84 a5 6a 94 dc 1f 7f | 62 f5 aa 4b 5e 15 7f 93
4e b0 fe 23 62 40 a5 65 | 27 b9 08 b1 d1 a1 b1 db
8e c7 6a 58 7c 86 62 33 | 27 b9 08 b1 d1 a1 b1 db
</code></pre><p>First thing to note, all the bits are used. which disqualifies offsets or simple enum ids like before.</p>
<p>Right now, we are not even if sure these 128 bits are part of one 128 bits field (for example a hash), two 64 bits integers, four 32 integers, or any combination of 16, 32 or 64 bits that ends-up making a 128 bits chunk.</p>
<p>Looking at it more closely, the first 64 bits looks rather random, the last 64 bits however? we see quite a few values repeating themselves (ex: <code>27 b9 08 b1 d1 a1 b1 db</code>).</p>
<p>Lets check the whole file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx| grep <span style="color:#e6db74">&#39;00 00 00 00 00 00 00&#39;</span> | sed <span style="color:#e6db74">&#39;s/^..........//&#39;</span> | sed <span style="color:#e6db74">&#39;s/  .*//&#39;</span> | sort  | uniq -c | sort -n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># note: first number is the number of occurance</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> af
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> 1c 6a 8d 7f df 8e b3 <span style="color:#ae81ff">35</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">71</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 1c <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> 7d e3 1c a4 <span style="color:#ae81ff">35</span> 3e <span style="color:#ae81ff">98</span> 8b
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> e0 <span style="color:#ae81ff">95</span> <span style="color:#ae81ff">53</span> f6 cc <span style="color:#ae81ff">08</span> c0 <span style="color:#ae81ff">46</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">58</span> <span style="color:#ae81ff">36</span> c8 ec <span style="color:#ae81ff">47</span> 8b
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2</span> 4e b0 fe <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">40</span> a5 <span style="color:#ae81ff">65</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">2</span> d0 d7 a5 ce a8 <span style="color:#ae81ff">86</span> 0e ae
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> 1a aa c7 3c 4e <span style="color:#ae81ff">76</span> ad <span style="color:#ae81ff">94</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> 4c d1 2e <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">38</span> d9 <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> 4c f0 ea c1 d5 5a 8d <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">57</span> fc 1c <span style="color:#ae81ff">72</span> f3 <span style="color:#ae81ff">84</span> fa
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> ac <span style="color:#ae81ff">82</span> d5 f6 9e db <span style="color:#ae81ff">47</span> f9
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> b1 <span style="color:#ae81ff">86</span> <span style="color:#ae81ff">45</span> dc 7a <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">38</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">3</span> fc <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">83</span> 2d <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">30</span> a3
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">83</span> <span style="color:#ae81ff">17</span> b5 cf dd b7 0e
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">06</span> cf <span style="color:#ae81ff">85</span> bd <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">99</span> e2 <span style="color:#ae81ff">46</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">09</span> <span style="color:#ae81ff">28</span> f1 df 2d <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">93</span> de
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">10</span> a4 eb 1b 3e <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">21</span> d8 <span style="color:#ae81ff">74</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">10</span> d7 <span style="color:#ae81ff">22</span> 2f fc 0a <span style="color:#ae81ff">67</span> 7a 0d
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">14</span> aa db f0 <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">89</span> b6 d8
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">15</span> df <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">67</span> c7 3a dd 7a
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">19</span> ac <span style="color:#ae81ff">65</span> 3f <span style="color:#ae81ff">91</span> <span style="color:#ae81ff">78</span> <span style="color:#ae81ff">97</span> dc
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">38</span> e6 <span style="color:#ae81ff">83</span> 3c <span style="color:#ae81ff">74</span> a7 <span style="color:#ae81ff">20</span> b2
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">19</span> <span style="color:#ae81ff">59</span> dc e0 <span style="color:#ae81ff">43</span> fc <span style="color:#ae81ff">88</span> b7 7c
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">23</span> d3 9e <span style="color:#ae81ff">86</span> <span style="color:#ae81ff">23</span> <span style="color:#ae81ff">25</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">27</span> <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">24</span> 0e <span style="color:#ae81ff">48</span> <span style="color:#ae81ff">58</span> ea <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">44</span> 1a <span style="color:#ae81ff">47</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">33</span> d7 <span style="color:#ae81ff">19</span> f3 <span style="color:#ae81ff">03</span> 3e 6e <span style="color:#ae81ff">59</span> <span style="color:#ae81ff">03</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">34</span> <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">38</span> <span style="color:#ae81ff">62</span> f5 aa 4b 5e <span style="color:#ae81ff">15</span> 7f <span style="color:#ae81ff">93</span>
</span></span></code></pre></div><p>Indeed, the repetitions are quite frequent, and running the same command on other files yeild roughly the same values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C particles.idx| grep <span style="color:#e6db74">&#39;00 00 00 00 00 00 00&#39;</span> | sed <span style="color:#e6db74">&#39;s/^..........//&#39;</span> | sed <span style="color:#e6db74">&#39;s/  .*//&#39;</span> | sort  | uniq -c | sort -n 
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">27</span> b9 <span style="color:#ae81ff">08</span> b1 d1 a1 b1 db
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> 8e ae <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> bd <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> b7 <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">4</span> ca 2c b7 <span style="color:#ae81ff">97</span> <span style="color:#ae81ff">24</span> b8 1c <span style="color:#ae81ff">86</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">5</span> 1f <span style="color:#ae81ff">19</span> a6 0c a2 9b 7f b3
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">16</span> <span style="color:#ae81ff">94</span> a1 <span style="color:#ae81ff">23</span> f4 c5 <span style="color:#ae81ff">41</span> b8 <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">91</span> cc <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">25</span> 2a <span style="color:#ae81ff">42</span> d4
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">81</span> de 3e <span style="color:#ae81ff">45</span> 0e <span style="color:#ae81ff">99</span> dc <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">317</span> <span style="color:#ae81ff">66</span> <span style="color:#ae81ff">52</span> <span style="color:#ae81ff">00</span> d6 <span style="color:#ae81ff">89</span> <span style="color:#ae81ff">64</span> 1d 2e
</span></span></code></pre></div><p>More over, <code>sound_music.idx</code> wchi as the name implies probably only contains sound files returns mostly one type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C sound_music.idx| grep <span style="color:#e6db74">&#39;00 00 00 00 00 00 00&#39;</span> | sed <span style="color:#e6db74">&#39;s/^..........//&#39;</span> | sed <span style="color:#e6db74">&#39;s/  .*//&#39;</span> | sort  | uniq -c | sort -n
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">513</span> <span style="color:#ae81ff">93</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">56</span> c2 <span style="color:#ae81ff">97</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">69</span>
</span></span></code></pre></div><p>Note: these commands are by no mean accurate, they are likely to catch garbage and miscount. But these are quick and dirty ways to validate hypothesis.</p>
<p>So it seems we are dealing with another <code>file_type</code> field. Let&rsquo;s call it <code>file_type2</code>, and rename the first one <code>file_type1</code>.</p>
<p>So in the end, making a few assumptions, for now, we have figured out that the rough format of this section:</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
| T1 | T1 | T1 | T1 | T1 | T1 | T1 | T1 || OF | OF | OF | OF | OF | OF | OF | OF |
+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
|&lt;---------- file type 1 --------------&gt;||&lt;------------ offset -----------------&gt;|
|               64 bits                 ||               64 bits                 |
+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
| UN | UN | UN | UN | UN | UN | UN | UN || T2 | T2 | T2 | T2 | T2 | T2 | T2 | T2 |
+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
|&lt;------------ unknown ----------------&gt;||&lt;---------- file type 2 --------------&gt;|
|               64 bits                 ||               64 bits                 |
</code></pre><h3 id="header">Header</h3>
<p>Now, lets start analyzing the header part of the <code>.idx</code>.</p>
<p>Here is the first bytes on an <code>.idx</code> file.</p>
<pre tabindex="0"><code>00000000  49 53 46 50 00 00 00 02  91 9d 39 b4 40 00 00 00  |ISFP......9.@...|
00000010  37 01 00 00 1c 01 00 00  01 00 00 00 00 00 00 00  |7...............|
00000020  28 00 00 00 00 00 00 00  f6 3b 00 00 00 00 00 00  |(........;......|
00000030  36 71 00 00 00 00 00 00  0e 00 00 00 00 00 00 00  |6q..............|
00000040  e0 26 00 00 00 00 00 00  8f 0c 9a ba 4f 40 b6 93  |.&amp;..........O@..|
00000050  27 b9 08 b1 d1 a1 b1 db  13 00 00 00 00 00 00 00  |&#39;...............|
00000060  ce 26 00 00 00 00 00 00  8f ec 87 4a 28 d0 f7 c7  |.&amp;.........J(...|
00000070  a4 eb 1b 3e 50 21 d8 74  12 00 00 00 00 00 00 00  |...&gt;P!.t........|
00000080  c1 26 00 00 00 00 00 00  ad 70 a2 e7 ac 2c 4f 6b  |.&amp;.......p...,Ok|
00000090  27 b9 08 b1 d1 a1 b1 db  0e 00 00 00 00 00 00 00  |&#39;...............|
</code></pre><p>These first bytes don&rsquo;t look like the <code>section</code> previously mentionned, we have a magic number (<code>ISFP</code>) and then the content doesn&rsquo;t look like a <code>section</code> at first (too many low value 32 bits integers).</p>
<p>This means we most likely have an header section containing things like:</p>
<ul>
<li>magic numbers</li>
<li>types</li>
<li>sizes</li>
<li>number of entries/files</li>
</ul>
<p>The first thing to determine is the size of the header. Looking at it, the first <code>section</code> starts at <code>0x38</code> (recognisable by they full 64 bits integers).</p>
<p>This means the header is 7 x 64 bits.</p>
<p>Lets analyze the content.</p>
<p>Looking at all the files, for the first 128 bits, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » <span style="color:#66d9ef">for</span> i in *;<span style="color:#66d9ef">do</span> hexdump -C $i | head -n 1;<span style="color:#66d9ef">done</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  1b <span style="color:#ae81ff">73</span> f9 d5 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP.....s..@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">78</span> f0 2c <span style="color:#ae81ff">09</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP....x.,.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  b8 fe ba b9 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP........@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">24</span> fa 2d <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP.....$.-@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  1e 7e f6 d9 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP.....~..@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  dd <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">74</span> c2 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP.....!t.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">33</span> <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">63</span> bd <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP....3<span style="color:#f92672">(</span>c.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  cb 5c e2 0d <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP.....<span style="color:#ae81ff">\.</span>.@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  cb e8 8a fd <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP........@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  6e <span style="color:#ae81ff">04</span> b1 <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP....n..b@...|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000000</span>  <span style="color:#ae81ff">49</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">46</span> <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">15</span> 1c a2 f9 <span style="color:#ae81ff">40</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |ISFP........@...|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>As we can see, the 1st, 2nd, and 4th 32 bits chunck are always the same, and looking at the values, we have respectively:</p>
<ul>
<li>a magic number (<code>ISFP</code>),</li>
<li><code>00 00 00 02</code> which is rather weird (it could be some kind of id, if we were little endian, but the format is big endian). Maybe it is actually part of the magic number. As it doesn&rsquo;t vary, it&rsquo;s not too important for the task at end there.</li>
<li><code>40 00 00 00</code> which like <code>type 1</code> looks like a low value enum, and given its position in the index file, within the header, we are most likely dealing with an archive type. Again, as it doesn&rsquo;t vary, it&rsquo;s not really important.</li>
</ul>
<p>The 3rd 32 bits integer uses all the available bits, so it&rsquo;s unlikely a size. Maybe it&rsquo;s a CRC32 or a unique ID for the archives.</p>
<p>Edit: the <code>40 00 00 00</code> value upon closer inspection might not be an archive type, its value is 64 in decimal, which might be an header size, or simply storing the size of an integer.</p>
<p>So we have:</p>
<pre tabindex="0"><code>+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| MA | MA | MA | MA || 00 | 00 | 00 | 02 || ID | ID | ID | ID || 40 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;----- magic -----&gt;||&lt;----- ???? ------&gt;||&lt;---- id/crc -----&gt;||&lt;----- ??????? ---&gt;|
</code></pre><p>Now, lets look at the next 128 bits (second line in hexdump).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » <span style="color:#66d9ef">for</span> i in *;<span style="color:#66d9ef">do</span> hexdump -C $i | head -n <span style="color:#ae81ff">2</span> | tail -n 1;<span style="color:#66d9ef">done</span>                                                                                                                                                                                                                                    <span style="color:#ae81ff">130</span> ↵
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  bd <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> b7 <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">35</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 1d <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |5...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  5b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">[</span>...W...........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  5c <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">58</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#ae81ff">\.</span>..X...........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ff <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">29</span> 3b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 0b 3b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">)</span>;...;..........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  1e <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> c2 <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  a5 <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |....6...........|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">04</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> fb <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> a9 <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |y...............|
</span></span></code></pre></div><p>So here, we recognize two 32 bits integers due to the <code>00 00</code>,  and then either a fixed 64 bits integer with always a <code>01 00 00 00 00 00 00 00</code> value, or something like two 32 bits integers with value <code>01 00 00 00</code> and <code>00 00 00 00</code> (as the value never varies, again, it&rsquo;s not that important).</p>
<p>Lets try to determine the two 32 bits values. Let&rsquo;s look at one of the files in particular:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000010</span>  <span style="color:#ae81ff">37</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 1c <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |7...............|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The first value is <span style="color:#e6db74">`</span><span style="color:#ae81ff">37</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> 00<span style="color:#e6db74">`</span>, i.e. converted to decimal, <span style="color:#e6db74">`</span>311<span style="color:#e6db74">`</span>. Doing a strings <span style="color:#e6db74">`</span>strings system_data.idx &gt;listing<span style="color:#e6db74">`</span> and remove manually the garbage <span style="color:#f92672">(</span>ex: <span style="color:#e6db74">`</span>w6~n<span style="color:#e6db74">`</span><span style="color:#f92672">)</span> as best as possible, plus the <span style="color:#e6db74">`</span>.pkg<span style="color:#e6db74">`</span> file name, only keeping files and directory names, we get <span style="color:#e6db74">`</span>310<span style="color:#e6db74">`</span> entries, a remarquably close value.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Looking at other files, story is similar, this field roughly matches the number of strings we get from <span style="color:#e6db74">`</span>strings<span style="color:#e6db74">`</span> <span style="color:#f92672">(</span>never perfectly however, but <span style="color:#66d9ef">if</span> the names are too short, <span style="color:#e6db74">`</span>strings<span style="color:#e6db74">`</span> will ignore them, most likely explaining the small delta we have each time<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Consequently we can deduce it<span style="color:#e6db74">&#39;s most likely the number of entries (files and directories) in the index file.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Next, we have `1c 01 00 00`, i.e. converted to decimal, `284`. This value is suspisiously close to the previous value. As we have both directories and file names, this number probably represents the number of items which are actual files.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Let&#39;</span>s validate that:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">```</span>shell
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Q&amp;D filtering out names without an extension (no &#39;.&#39;)</span>
</span></span><span style="display:flex;"><span>kakwa@linux 6775398/idx » cat listing | grep  <span style="color:#e6db74">&#39;\.&#39;</span> | wc -l 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">284</span>
</span></span></code></pre></div><p>Bingo, we have the exact number we were looking for.</p>
<p>The last 64 bits could simply be ignored for now since they always have the same value.</p>
<p>So we have:</p>
<pre tabindex="0"><code>+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| FD | FD | FD | FD || FI | FI | FI | FI || 01 | 00 | 00 | 00 || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;file + dir count &gt;||&lt;-- file count ---&gt;||&lt;-------------- ???? ------------------&gt;|
</code></pre><p>Next 128 bits:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » <span style="color:#66d9ef">for</span> i in *;<span style="color:#66d9ef">do</span> hexdump -C $i | head -n <span style="color:#ae81ff">3</span> | tail -n 1;<span style="color:#66d9ef">done</span> | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">58</span> 8d <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>.......X.......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  7c 3f <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>.......|?......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">77</span> 2f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>.......w/......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  bc e9 <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  c6 ea <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  a9 0f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000020</span>  <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  c4 <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |<span style="color:#f92672">(</span>........<span style="color:#e6db74">&#34;......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  b6 2b 00 00 00 00 00 00  |(........+......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  d6 41 00 00 00 00 00 00  |(........A......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  fd 21 00 00 00 00 00 00  |(........!......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  e1 25 00 00 00 00 00 00  |(........%......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  f5 31 00 00 00 00 00 00  |(........1......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  1e 42 00 00 00 00 00 00  |(........B......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00000020  28 00 00 00 00 00 00 00  70 42 02 00 00 00 00 00  |(.......pB......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span></code></pre></div><p>So here, we have 2 64 bits integers, the first one is <code>28 00 00 00 00 00 00 00</code> and always has the same value, not sure what it represents, the value is somewhat close to the header size in bytes: 40 for this value, 56 for the full header size.</p>
<p>Maybe the header could vary in size in certain situations, and this represents its size minus some fixed part (like the first 16 bytes/128 bits). I&rsquo;m also kind of betting that if the previous 64 bits integer (<code>01 00 00 00 00 00 00 00</code> changes, this will also change.</p>
<p>But as it never varies in the set of index files we have here, we cannot really make any deduction, only guesses. So once again, lets ignore it.</p>
<p>At this point, the idea of downloading other Wargaming games like World of Tanks or World of Warplanes popped-up, maybe this will give complementary information regarding the unknown fields that starts to pile-up.</p>
<p>But lets continue for now.</p>
<p>EDIT: It&rsquo;s no help, World of Tanks and World of Warplanes simply pack their resources in <code>.zip</code> files&hellip;
It&rsquo;s a wild guess, but I kind of expect WoWs to be the same in the futur.
The WoWs packing format feels in fact somewhat legacy, custom and far less efficient than a standard &amp; run of the mill <code>.zip</code> file. Not to mention using <code>.zip</code> files means removing one bit of code to maintain.</p>
<p>The next value is again a 64 bits integer, it changes between each files.</p>
<p>lets focus on one file:</p>
<pre tabindex="0"><code>[...]
00000020  28 00 00 00 00 00 00 00  f6 3b 00 00 00 00 00 00  |(........;......|
[...]
</code></pre><p>At first, I though it might be a file size, but quickly checking the index file size, I got:</p>
<ul>
<li>index file size: 29043</li>
<li>value of this field in decimal: 15350</li>
</ul>
<p>Checking another file, I got 77461 and 44807.</p>
<p>So no, it&rsquo;s not the index size. However it is suspisously ~1/2 of the file size, and after having stared at hexdumps for hours, I had another idea.</p>
<p>The third chunk of the file is right after the bundle of dir/file name strings which varies in length wildly (e.i, it&rsquo;s not fixed length or a multiple of a fix length).</p>
<p>We probably need an offset pointing to the start of this section in the header.</p>
<p>And sure enough, looking where the bundle of strings stops, we get:</p>
<pre tabindex="0"><code>00003bd0  6f 69 73 65 2e 64 64 73  00 73 70 61 63 65 5f 76  |oise.dds.space_v|
00003be0  61 72 69 61 74 69 6f 6e  5f 64 75 6d 6d 79 2e 64  |ariation_dummy.d|
00003bf0  64 73 00 77 61 76 65 73  5f 68 65 69 67 68 74 73  |ds.waves_heights|
00003c00  30 2e 64 64 73 00 8f ec  87 4a 28 d0 f7 c7 70 11  |0.dds....J(...p.|
00003c10  03 07 0d 33 ed 77 1e 9b  ef 05 00 00 00 00 05 00  |...3.w..........|
</code></pre><p>Okay, the string bundle ends at 00003c05, that&rsquo;s quite near 3b f6, so this is certainly the offset to this third section or the end of the bundle of strings.</p>
<p>Most likely, the offset is not from the start of the file, but from a specific in the header (this field? end of header?), that&rsquo;s why we get a -15 difference (0x00003c05 - 0x3bf6 = 0xF = 15). This -15 value is constant between file.</p>
<p>So we have:</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
| HS | HS | HS | HS | HS | HS | HS | HS || OF | OF | OF | OF | OF | OF | OF | OF |
+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
|&lt;------------ header size (?) --------&gt;||&lt;---- offset third section start -----&gt;|
</code></pre><p>Last 64 bits:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6623042/idx » <span style="color:#66d9ef">for</span> i in *;<span style="color:#66d9ef">do</span> hexdump -C $i | head -n <span style="color:#ae81ff">4</span> | tail -n 1;<span style="color:#66d9ef">done</span> | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">40</span> af <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  1b <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |@...............|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">54</span> 8d 1f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |T.......!.......|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  8e ae <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">17</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">81</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00000030</span>  c9 <span style="color:#ae81ff">24</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  1f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |.$..............|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>So, we have a 64 bits integer, which is relatively low value. This means it&rsquo;s most like a size or an offset.</p>
<p>If we pick one:</p>
<pre tabindex="0"><code>hexdump -C system_data.idx | less
[...]
00000030  36 71 00 00 00 00 00 00  13 00 00 00 00 00 00 00  |6q..............|
[...]
</code></pre><p>We can see that the <code>36 71 00 00 00 00 00 00</code>, 28982 once converted to decimal, is remarkably close to the file size (29043 bytes).</p>
<p>From their, we can guess it might be three things:</p>
<ul>
<li>the actual index file size</li>
<li>an offset to something at the end of the file</li>
<li>pointer to the end of the third section</li>
</ul>
<p>Lets note that for now, and figure out the finer details at implementation time.</p>
<p>So, to recap, here is the header section format:</p>
<pre tabindex="0"><code>+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| MA | MA | MA | MA || 00 | 00 | 00 | 02 || ID | ID | ID | ID || 40 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;----- magic -----&gt;||&lt;----- ???? ------&gt;||&lt;---- id/crc -----&gt;||&lt;----- ??????? ---&gt;|

+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| FD | FD | FD | FD || FI | FI | FI | FI || 01 | 00 | 00 | 00 || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;file + dir count &gt;||&lt;-- file count ---&gt;||&lt;-------------- ???? ------------------&gt;|

+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
| HS | HS | HS | HS | HS | HS | HS | HS  ||  OF | OF | OF | OF | OF | OF | OF | OF |
+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
|&lt;------------ header size (?) ---------&gt;||&lt;----- offset third section start -----&gt;|

+====+====+====+====+====+====+====+=====+
| OE | OE | OE | OE | OE | OE | OE | OE  |
+====+====+====+====+====+====+====+=====+
|&lt;---- offset third section end --------&gt;|
</code></pre><h3 id="format-of-the-middle-section">Format of the middle section</h3>
<p>Not much to say there.</p>
<p>Here what it looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx| less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002700</span>  fb <span style="color:#ae81ff">14</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">74</span> d1 1b 8d f4 ff 7a ce  |........t.....z.|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002710</span>  a4 eb 1b 3e <span style="color:#ae81ff">50</span> <span style="color:#ae81ff">21</span> d8 <span style="color:#ae81ff">74</span>  4b <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">74</span> 6f <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">67</span>  |...&gt;P!.tKDStorag|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002720</span>  <span style="color:#ae81ff">65</span> 2e <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> 6e <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">61</span>  <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span> 5f <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">67</span>  |e.bin.waves_heig|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00002730</span>  <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">31</span> 2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">61</span> 6e <span style="color:#ae81ff">69</span> 6d <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">65</span>  |hts1.dds.animate|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>000028c0  <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">73</span> 2e <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">69</span> 6e <span style="color:#ae81ff">00</span> 6d  <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">53</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">69</span>  |ts.bin.miscSetti|
</span></span><span style="display:flex;"><span>000028d0  6e <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">73</span> 2e <span style="color:#ae81ff">78</span> 6d 6c <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">61</span> 6d <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">65</span> 5f <span style="color:#ae81ff">64</span>  |ngs.xml.damage_d|
</span></span><span style="display:flex;"><span>000028e0  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">63</span> 5f <span style="color:#ae81ff">32</span> 5f <span style="color:#ae81ff">64</span> 2e <span style="color:#ae81ff">64</span>  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">32</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">61</span> 6d <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">67</span>  |ec_2_d.dd2.damag|
</span></span><span style="display:flex;"><span>000028f0  <span style="color:#ae81ff">65</span> 5f <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">63</span> 5f <span style="color:#ae81ff">31</span> 5f  <span style="color:#ae81ff">65</span> 2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">72</span>  |e_dec_1_e.dds.cr|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>00003be0  <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">69</span> 6f 6e  5f <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">75</span> 6d 6d <span style="color:#ae81ff">79</span> 2e <span style="color:#ae81ff">64</span>  |ariation_dummy.d|
</span></span><span style="display:flex;"><span>00003bf0  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span>  5f <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">73</span>  |ds.waves_heights|
</span></span><span style="display:flex;"><span>00003c00  <span style="color:#ae81ff">30</span> 2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> 8f 0c  9a ba 4f <span style="color:#ae81ff">40</span> b6 <span style="color:#ae81ff">93</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |0.dds.....O@..p.|
</span></span><span style="display:flex;"><span>00003c10  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w..........|
</span></span><span style="display:flex;"><span>00003c20  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f5 <span style="color:#ae81ff">21</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> bf <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">45</span> 5c 6c <span style="color:#ae81ff">36</span>  |.......!....E<span style="color:#ae81ff">\l</span>6|
</span></span></code></pre></div><p>So it&rsquo;s a bunch of <code>\0</code> separated strings. The only thing interesting to note is that it&rsquo;s not a fixed size section.</p>
<h3 id="format-of-the-third-section">Format of the third section</h3>
<p>Here what it looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -C system_data.idx| less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>00003bf0  <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span>  5f <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">73</span>  |ds.waves_heights|
</span></span><span style="display:flex;"><span>00003c00  <span style="color:#ae81ff">30</span> 2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> 8f 0c  9a ba 4f <span style="color:#ae81ff">40</span> b6 <span style="color:#ae81ff">93</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |0.dds.....O@..p.|
</span></span><span style="display:flex;"><span>00003c10  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w..........|
</span></span><span style="display:flex;"><span>00003c20  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f5 <span style="color:#ae81ff">21</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> bf <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">45</span> 5c 6c <span style="color:#ae81ff">36</span>  |.......!....E<span style="color:#ae81ff">\l</span>6|
</span></span><span style="display:flex;"><span>00003c30  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 8f ec  <span style="color:#ae81ff">87</span> 4a <span style="color:#ae81ff">28</span> d0 f7 c7 <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.........J<span style="color:#f92672">(</span>...p.|
</span></span><span style="display:flex;"><span>00003c40  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> 1e 9b  ef <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w..........|
</span></span><span style="display:flex;"><span>00003c50  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">97</span> 3e ab  |...........wc.&gt;.|
</span></span><span style="display:flex;"><span>00003c60  <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> ad <span style="color:#ae81ff">70</span>  a2 e7 ac 2c 4f 6b <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.......p...,Okp.|
</span></span><span style="display:flex;"><span>00003c70  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">22</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w.<span style="color:#e6db74">&#34;........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c80  00 00 01 00 00 00 cb 01  00 00 6d b9 de c1 ad 0c  |..........m.....|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003c90  00 00 00 00 00 00 8e c7  6a 58 7c 86 62 33 70 11  |........jX|.b3p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003ca0  03 07 0d 33 ed 77 e0 23  00 00 00 00 00 00 05 00  |...3.w.#........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003cb0  00 00 01 00 00 00 65 00  00 00 f1 d2 87 5a d2 00  |......e......Z..|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003cc0  00 00 00 00 00 00 8e 43  3d e9 cf 49 52 a4 70 11  |.......C=..IR.p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003cd0  03 07 0d 33 ed 77 4d 1f  6a 05 00 00 00 00 05 00  |...3.wM.j.......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003ce0  00 00 01 00 00 00 bb 19  00 00 f7 53 4a b1 38 ab  |...........SJ.8.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00003cf0  00 00 00 00 00 00 0e 3c  9a 6d 22 de 7b da 70 11  |.......&lt;.m&#34;</span>.<span style="color:#f92672">{</span>.p.|
</span></span><span style="display:flex;"><span>00003d00  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">55</span> <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.wU$........|
</span></span><span style="display:flex;"><span>00003d10  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">72</span> 0d  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">83</span> 0a <span style="color:#ae81ff">72</span> <span style="color:#ae81ff">88</span> a3 5c  |......r.....r..<span style="color:#ae81ff">\|</span>
</span></span><span style="display:flex;"><span>00003d20  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">45</span>  <span style="color:#ae81ff">00</span> 7a <span style="color:#ae81ff">16</span> 6e <span style="color:#ae81ff">84</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.......E.z.n.!p.|
</span></span><span style="display:flex;"><span>00003d30  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">73</span> ce  cb <span style="color:#ae81ff">06</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.ws.........|
</span></span><span style="display:flex;"><span>00003d40  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> f9 b6  b7 <span style="color:#ae81ff">00</span> ff 7e f7 7b 5b <span style="color:#ae81ff">30</span>  |...........~.<span style="color:#f92672">{[</span>0|
</span></span><span style="display:flex;"><span>00003d50  b8 <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">98</span> <span style="color:#ae81ff">51</span>  4a <span style="color:#ae81ff">00</span> 2c <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">71</span> ad <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |.......QJ.,.q.p.|
</span></span><span style="display:flex;"><span>00003d60  <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span> 7e <span style="color:#ae81ff">63</span>  <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span>  |...3.w~cu.......|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007100</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 6f <span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> fc <span style="color:#ae81ff">56</span> <span style="color:#ae81ff">94</span> f8 9a <span style="color:#ae81ff">37</span>  |......o....V...7|
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007110</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">67</span>  ac <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">22</span> ec ca b8 <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span>  |......!g.p<span style="color:#e6db74">&#34;...p.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007120  03 07 0d 33 ed 77 28 f9  15 0a 00 00 00 00 05 00  |...3.w(.........|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007130  00 00 01 00 00 00 0b 2d  00 00 03 bd b0 50 67 e9  |.......-.....Pg.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007140  00 00 00 00 00 00 15 00  00 00 00 00 00 00 18 00  |................|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007150  00 00 00 00 00 00 70 11  03 07 0d 33 ed 77 73 79  |......p....3.wsy|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007160  73 74 65 6d 5f 64 61 74  61 5f 30 30 30 31 2e 70  |stem_data_0001.p|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007170  6b 67 00                                          |kg.|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007173
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">(END)
</span></span></span></code></pre></div><p>Right away, we can notice 3 things:</p>
<ul>
<li>like before, it looks cyclical</li>
<li>it contains the IDs of the pkg file</li>
<li>it ends with the <code>.pkg</code> file name.</li>
</ul>
<p>One cycle probably contains other metadata about a packaged file.</p>
<p>Lets try to first determine the size of these cycles.</p>
<p>first, lets &ldquo;reallign&rdquo; the hexdump.</p>
<p>Here the last file name strings ends at 00003c05 (last &lsquo;\0&rsquo;), which means 6 bytes.</p>
<p>hexdump has a convinient <code>-s</code> (skip) option for that.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># lets skip the first 6 bytes to allign hexdump output</span>
</span></span><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -s <span style="color:#ae81ff">6</span> -C system_data.idx| less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>00003be6  6f 6e 5f <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">75</span> 6d 6d <span style="color:#ae81ff">79</span>  2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">61</span> <span style="color:#ae81ff">76</span>  |on_dummy.dds.wav|
</span></span><span style="display:flex;"><span>00003bf6  <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">73</span> 5f <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">65</span> <span style="color:#ae81ff">69</span> <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">68</span>  <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">30</span> 2e <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">64</span> <span style="color:#ae81ff">73</span> <span style="color:#ae81ff">00</span>  |es_heights0.dds.|
</span></span><span style="display:flex;"><span>00003c06  8f 0c 9a ba 4f <span style="color:#ae81ff">40</span> b6 <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span>  |....O@..p....3.w|
</span></span><span style="display:flex;"><span>00003c16  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span>00003c26  f5 <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> bf <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">45</span> 5c  6c <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |.!....E<span style="color:#ae81ff">\l</span>6......|
</span></span><span style="display:flex;"><span>00003c36  8f ec <span style="color:#ae81ff">87</span> 4a <span style="color:#ae81ff">28</span> d0 f7 c7  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span>  |...J<span style="color:#f92672">(</span>...p....3.w|
</span></span><span style="display:flex;"><span>00003c46  1e 9b ef <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">05</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |................|
</span></span><span style="display:flex;"><span>00003c56  <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">15</span> <span style="color:#ae81ff">01</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">97</span>  3e ab <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |.....wc.&gt;.......|
</span></span><span style="display:flex;"><span>00003c66  ad <span style="color:#ae81ff">70</span> a2 e7 ac 2c 4f 6b  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span>  |.p...,Okp....3.w|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Much nicer!</p>
<p>With that, we immediately notice some cycle, with the <code>70 11 03 07 0d 33 ed 77</code> value.</p>
<p>There are 6 x 64 = 384 bits between each <code>70 11 03 07 0d 33 ed 77</code> value.</p>
<p>let&rsquo;s try to confirm that with the IDs.</p>
<p>We are spotting the <code>bf 00 45 5c 6c 36</code> seen previously in the <code>.pkg</code> file. 384 bits later, we see <code>03 77 63 97 3e ab 02</code>.</p>
<p>With a bit of digging (it&rsquo;s right in the middle of the <code>.pkg</code> file, and this ID is not neetly in a 64 bits aligned chunk because of the variable size of the Deflate blocks), we indeed find it.</p>
<p>We have indeed a 384 bits cycle, which neetly fits in 3 lines of hexdump!</p>
<p>So each of these is one record:</p>
<pre tabindex="0"><code>00003c06  8f 0c 9a ba 4f 40 b6 93  70 11 03 07 0d 33 ed 77  |....O@..p....3.w|
00003c16  00 00 00 00 00 00 00 00  05 00 00 00 01 00 00 00  |................|
00003c26  f5 21 00 00 bf 00 45 5c  6c 36 00 00 00 00 00 00  |.!....E\l6......|
</code></pre><pre tabindex="0"><code>00003c36  8f ec 87 4a 28 d0 f7 c7  70 11 03 07 0d 33 ed 77  |...J(...p....3.w|
00003c46  1e 9b ef 05 00 00 00 00  05 00 00 00 01 00 00 00  |................|
00003c56  15 15 01 00 03 77 63 97  3e ab 02 00 00 00 00 00  |.....wc.&gt;.......|
</code></pre><pre tabindex="0"><code>00003c66  ad 70 a2 e7 ac 2c 4f 6b  70 11 03 07 0d 33 ed 77  |.p...,Okp....3.w|
00003c76  05 22 00 00 00 00 00 00  05 00 00 00 01 00 00 00  |.&#34;..............|
00003c86  cb 01 00 00 6d b9 de c1  ad 0c 00 00 00 00 00 00  |....m...........|
</code></pre><pre tabindex="0"><code>00003c96  8e c7 6a 58 7c 86 62 33  70 11 03 07 0d 33 ed 77  |..jX|.b3p....3.w|
00003ca6  e0 23 00 00 00 00 00 00  05 00 00 00 01 00 00 00  |.#..............|
00003cb6  65 00 00 00 f1 d2 87 5a  d2 00 00 00 00 00 00 00  |e......Z........|
</code></pre><pre tabindex="0"><code>00003cc6  8e 43 3d e9 cf 49 52 a4  70 11 03 07 0d 33 ed 77  |.C=..IR.p....3.w|
00003cd6  4d 1f 6a 05 00 00 00 00  05 00 00 00 01 00 00 00  |M.j.............|
00003ce6  bb 19 00 00 f7 53 4a b1  38 ab 00 00 00 00 00 00  |.....SJ.8.......|
</code></pre><p>All these records are from the same file,</p>
<p>lets grab a few from other files:</p>
<p>File 2:</p>
<pre tabindex="0"><code>0000f6fd  58 fe 65 b4 59 b6 b0 77  a4 8c 78 6a 58 aa 65 84  |X.e.Y..w..xjX.e.|
0000f70d  00 00 00 00 00 00 00 00  05 00 00 00 01 00 00 00  |................|
0000f71d  bc 99 05 00 f4 3a 67 8b  80 00 08 00 00 00 00 00  |.....:g.........|
</code></pre><pre tabindex="0"><code>0000f72d  a0 e5 c7 22 cc 49 d3 31  a4 8c 78 6a 58 aa 65 84  |...&#34;.I.1..xjX.e.|
0000f73d  3e 9e 7e 05 00 00 00 00  05 00 00 00 01 00 00 00  |&gt;.~.............|
0000f74d  79 c6 03 00 dc b8 5f 80  80 00 08 00 00 00 00 00  |y....._.........|
</code></pre><p>File 3:</p>
<pre tabindex="0"><code>00002d0c  ed cf 33 f8 a5 94 53 56  0d a7 9c b9 bf 60 f5 3e  |..3...SV.....`.&gt;|
00002d1c  40 a8 08 07 00 00 00 00  00 00 00 00 00 00 00 00  |@...............|
00002d2c  38 ab 00 00 5d cf 4e b6  38 ab 00 00 00 00 00 00  |8...].N.8.......|
</code></pre><pre tabindex="0"><code>00002d3c  ed ea da 52 4e 8f 70 ed  0d a7 9c b9 bf 60 f5 3e  |...RN.p......`.&gt;|
00002d4c  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00002d5c  98 00 00 00 a4 63 f2 9b  98 00 00 00 00 00 00 00  |.....c..........|
</code></pre><p>Lets study:</p>
<pre tabindex="0"><code>00003c06  8f 0c 9a ba 4f 40 b6 93  70 11 03 07 0d 33 ed 77  |....O@..p....3.w|
00003c16  00 00 00 00 00 00 00 00  05 00 00 00 01 00 00 00  |................|
00003c26  f5 21 00 00 bf 00 45 5c  6c 36 00 00 00 00 00 00  |.!....E\l6......|
</code></pre><p>For the first 128 bits we get:</p>
<pre tabindex="0"><code>00003c06  8f 0c 9a ba 4f 40 b6 93  70 11 03 07 0d 33 ed 77  |....O@..p....3.w|
</code></pre><p>From the fact the last 64 bits are constant, we can deduce we have probably two 64 bits integers in the first 128 bits</p>
<p>Once again, these are using all the available bits and seem rather random. It&rsquo;s difficult to link these to their role, so&hellip; lets simply ignore these for now.</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
| UO | UO | UO | UO | UO | UO | UO | UO || UT | UT | UT | UT | UT | UT | UT | UT |
+====+====+====+====+====+====+====+====++====+====+====+====+====+====+====+====+
|&lt;------------ unknown 1 --------------&gt;||&lt;------------- unknow 2 --------------&gt;|
|               64 bits                 ||               64 bits                 |
</code></pre><p>Next 64 bits, we have a low value 64 bits integer, so most likely an offset. It is also suspiciously at <code>0x0</code> for the first record which is also the first data chunk in the <code>.pkg</code> file.</p>
<p>So, it&rsquo;s most likely the start of a data chunk in a <code>.pkg</code> file. Looking at other records confirms that.</p>
<p>Next, we have two extremely low value 32 bits (0x5 and 0x1). So once again, most likely some kind of enum, lets call them <code>type1</code> and <code>type2</code>.</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
| OF | OF | OF | OF | OF | OF | OF | OF || T1 | T1 | T1 | T1 || T2 | T2 | T2 | T2 |
+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;----------start offset pkg ----------&gt;||&lt;---- type 1 -----&gt;||&lt;----- type 2 ----&gt;|
|               64 bits                 ||     32 bits       ||      32 bits      |
</code></pre><p>For the Last 128 bits, we get the following:</p>
<pre tabindex="0"><code>00003c26  f5 21 00 00 bf 00 45 5c  6c 36 00 00 00 00 00 00  |.!....E\l6......|
</code></pre><p>So, here, we see our <code>.pkg</code> ID (<code>bf 00 45 5c  6c 36</code>) right in the middle. Given its size, this ID is probably stored on 64 bits.</p>
<p>After that, last 32 bits, we get a bunch of <code>00</code>, maybe a reserved field, but more likely some kind of padding.</p>
<p>Before that, we get a low value 32 bits integer. When comparing with the <code>.pkg</code> file, <code>f5 21 00 00</code> is the offset where the first data chunk ends.</p>
<p>So it&rsquo;s the end offset. But 32 bits seems rather small to store such offset (specially given the start offset is 64 bits. Also, for other data chunks, this doesn&rsquo;t line-up.</p>
<p>However, it could very much be a relative offset (to the start of the data chunk).</p>
<p>Lets validate that with the second record</p>
<p>Record</p>
<pre tabindex="0"><code>00003c36  8f ec 87 4a 28 d0 f7 c7  70 11 03 07 0d 33 ed 77  |...J(...p....3.w|
00003c46  1e 9b ef 05 00 00 00 00  05 00 00 00 01 00 00 00  |................|
00003c56  15 15 01 00 03 77 63 97  3e ab 02 00 00 00 00 00  |.....wc.&gt;.......|
</code></pre><p>More hexdump! (searching the data chunk using the <code>03 77 63 97  3e ab 02</code> ID and the start offset <code>1e 9b ef 05 00 00 00 00</code>, or <code>0x05ef9b1e</code> once we take endianess into account):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux World of Warships/res_packages » hexdump -C system_data_0001.pkg | less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>05ef9b10  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">17</span> 4b <span style="color:#ae81ff">28</span> <span style="color:#ae81ff">42</span> <span style="color:#ae81ff">80</span> <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> 8c 7d  |...K<span style="color:#f92672">(</span>B.@.......<span style="color:#f92672">}</span>|
</span></span><span style="display:flex;"><span>05ef9b20  3b <span style="color:#ae81ff">50</span> 5d d9 b6 dd 7d b6  3e <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">15</span> b2 5f <span style="color:#ae81ff">20</span> <span style="color:#ae81ff">89</span> <span style="color:#ae81ff">04</span>  |;P<span style="color:#f92672">]</span>...<span style="color:#f92672">}</span>.&gt;v.._ ..|
</span></span><span style="display:flex;"><span>05ef9b30  <span style="color:#ae81ff">55</span> bd <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">44</span> <span style="color:#ae81ff">82</span> aa ec 7a  9c bd f7 <span style="color:#ae81ff">79</span> <span style="color:#ae81ff">45</span> <span style="color:#ae81ff">57</span> <span style="color:#ae81ff">39</span> <span style="color:#ae81ff">40</span>  |U..D...z...yEW9@|
</span></span><span style="display:flex;"><span>05ef9b40  <span style="color:#ae81ff">90</span> d0 4e 8c c0 <span style="color:#ae81ff">01</span> 9d <span style="color:#ae81ff">21</span>  <span style="color:#ae81ff">48</span> e8 0c <span style="color:#ae81ff">41</span> a2 ce <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">24</span>  |..N....!H..A...$|
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>05f0b010  d1 d7 <span style="color:#ae81ff">52</span> b0 de cc fa 9c  2b 8d b5 <span style="color:#ae81ff">57</span> a4 <span style="color:#ae81ff">02</span> ff 1a  |..R.....+..W....|
</span></span><span style="display:flex;"><span>05f0b020  <span style="color:#ae81ff">43</span> 5d 2d <span style="color:#ae81ff">43</span> 3f cc d1 0b  f8 <span style="color:#ae81ff">88</span> <span style="color:#ae81ff">92</span> a8 9f 5a <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">64</span>  |C<span style="color:#f92672">]</span>-C?........Zpd|
</span></span><span style="display:flex;"><span>05f0b030  <span style="color:#ae81ff">46</span> fb 7f <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">77</span> <span style="color:#ae81ff">63</span> <span style="color:#ae81ff">97</span> 3e ab <span style="color:#ae81ff">02</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span>  |F.......wc.&gt;....|
</span></span><span style="display:flex;"><span>05f0b040  <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">00</span> <span style="color:#ae81ff">94</span> b7 <span style="color:#ae81ff">67</span> <span style="color:#ae81ff">90</span> db  <span style="color:#ae81ff">68</span> 9e e6 d9 1f <span style="color:#ae81ff">36</span> <span style="color:#ae81ff">62</span> 6f  |.....g..h....6bo|
</span></span><span style="display:flex;"><span>05f0b050  6f <span style="color:#ae81ff">22</span> <span style="color:#ae81ff">76</span> f6 <span style="color:#ae81ff">62</span> e3 <span style="color:#ae81ff">62</span> <span style="color:#ae81ff">77</span>  <span style="color:#ae81ff">67</span> 7a 7a ba ab bb 8c aa  |o<span style="color:#e6db74">&#34;v.b.bwgzz.....|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">05f0b060  4a 52 95 5c ca a5 cf 64  d2 24 bd 27 41 d0 00 04  |JR.\...d.</span>$<span style="color:#e6db74">.&#39;A...|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[...]
</span></span></span></code></pre></div><p>We indeed find the start of our data chunk at <code>05ef9b1e</code> (<code>8c</code> after a bunch of <code>00</code> on the first line).</p>
<p>And looking for the <code>00 00 00 00 ID ID [...]</code> pattern in between the data chunks, we can determine the end of this chunk to be at <code>0x05f0b032</code>.</p>
<p>Doing <code>0x05f0b032 - 0x05ef9b1e</code>, we get <code>0x11514</code>, that&rsquo;s almost our <code>15 15 01 00</code> once we swap endianess, and add <code>1</code>.</p>
<pre tabindex="0"><code>+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
| OE | OE | OE | OE || ID | ID | ID | ID | ID | ID | ID | ID || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
|&lt;-- offset end ---&gt;||&lt;------------- ID &#39;.pkg&#39; -------------&gt;||&lt;---- padding ----&gt;|
|     32 bits       ||               64 bits                 ||      32 bits      |
</code></pre><p>So to recap, we have:</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
| UO | UO | UO | UO | UO | UO | UO | UO ||  UT | UT | UT | UT | UT | UT | UT | UT |
+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
|&lt;------------ unknown 1 --------------&gt;||&lt;-------------- unknown 2 -------------&gt;|
|               64 bits                 ||                64 bits                 |
+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
| OF | OF | OF | OF | OF | OF | OF | OF || T1 | T1 | T1 | T1 || T2 | T2 | T2 | T2 |
+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;--------- start offset pkg ----------&gt;||&lt;---- type 1 -----&gt;||&lt;----- type 2 ----&gt;|
|               64 bits                 ||     32 bits       ||      32 bits      |
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
| OE | OE | OE | OE || ID | ID | ID | ID | ID | ID | ID | ID || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
|&lt;-- offset end ---&gt;||&lt;------------- ID &#39;.pkg&#39; -------------&gt;||&lt;---- padding ----&gt;|
|     32 bits       ||               64 bits                 ||      32 bits      |
</code></pre><h3 id="the-last-bits">The last bits</h3>
<p>So, okay, we have the core of the 3 part of the file.</p>
<p>But we can see the last few bits don&rsquo;t follow this pattern (specially with the <code>.pkg</code> file name), which means we have a footer:</p>
<pre tabindex="0"><code># Last block
00007116  21 67 ac 70 22 ec ca b8  70 11 03 07 0d 33 ed 77  |!g.p&#34;...p....3.w|
00007126  28 f9 15 0a 00 00 00 00  05 00 00 00 01 00 00 00  |(...............|
00007136  0b 2d 00 00 03 bd b0 50  67 e9 00 00 00 00 00 00  |.-.....Pg.......|
# Footer
00007146  15 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
00007156  70 11 03 07 0d 33 ed 77  73 79 73 74 65 6d 5f 64  |p....3.wsystem_d|
00007166  61 74 61 5f 30 30 30 31  2e 70 6b 67 00           |ata_0001.pkg.|
</code></pre><p>If we look at the content, we have 3 * 64 bits before the name starts (<code>73 79 73 74 65 6d 5f 64</code> for <code>system_d</code> in)</p>
<p>Looking at it more closely, given all the <code>00</code>, it seems we have three 64 bits integers there.</p>
<ul>
<li><code>15 00 00 00 00 00 00 00</code></li>
<li><code>18 00 00 00 00 00 00 00</code></li>
<li><code>70 11 03 07 0d 33 ed 77</code></li>
</ul>
<p><code>70 11 03 07 0d 33 ed 77</code> is the &ldquo;unknown 2&rdquo; we saw previously, so still no luck, but lets name it the same way.</p>
<p><code>18 00 00 00 00 00 00 00</code> seems to have the same value accross all files, so probably not that important.</p>
<p>The only one that varies accross files is the <code>15 00 00 00 00 00 00 00</code>, but always in the same kind of values around 0x15. in decimal it&rsquo;s 21.</p>
<p>Strangely, <code>system_data_0001.pkg</code> is 20 chars long, 21 if we include the <code>\0</code> at the end.</p>
<p>So we can deduce it&rsquo;s actually the <code>.pkg</code> file name string size.</p>
<p>So we have</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
| UO | UO | UO | UO | UO | UO | UO | UO ||  U3 | U3 | U3 | U3 | U3 | U3 | U3 | U3 |
+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
|&lt;--------- size pkg file name --------&gt;||&lt;-------------- unknown 3 -------------&gt;|
|               64 bits                 ||                64 bits                 |
+=====+====+====+====+====+====+====+====+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~...
|  UT | UT | UT | UT | UT | UT | UT | UT |             file name string
+=====+====+====+====+====+====+====+====+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~...
|&lt;-------------- unknown 2 -------------&gt;|
|                64 bits                 |
</code></pre><h2 id="time-to-start-the-implementation">Time to start the implementation!</h2>
<h3 id="defining-the-structures">Defining the structures</h3>
<p>The first step is to define the structure matching what we saw previously.</p>
<p>I will not copy all the structures here (see <code>inc/wows-depack.h</code> for that), but it looks like that:</p>
<pre tabindex="0"><code>// INDEX file header
typedef struct {
    char magic[4];
    uint32_t unknown_1;
    uint32_t id;
    uint32_t unknown_2;
    uint32_t file_plus_dir_count;
    uint32_t file_count;
    uint64_t unknown_3;
    uint64_t header_size;
    uint64_t offset_idx_data_section;
    uint64_t offset_idx_footer_section;
} WOWS_INDEX_HEADER;
</code></pre><h3 id="start-parsing">Start Parsing</h3>
<p>Important disclaimer: the code presented here is extremely unsafe for clarity. it has no error handling and is very suceptible to buffer overflows. This will be fixed in the final code, but don&rsquo;t copy the examples presented here.</p>
<p>Initaly we will parse the index file and implement a human readable output. We will determine later what to do with the metadata we extract, for now, lets just display it.</p>
<h4 id="mapping-the-file">Mapping the file</h4>
<p>The first step is memory mapping the file content with <code>mmap</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Open the index file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(args.input, O_RDONLY);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Recover the file size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> stat s;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fstat</span>(fd, <span style="color:#f92672">&amp;</span>s);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">size_t</span> index_size <span style="color:#f92672">=</span> s.st_size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Map the whole content in memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>index_content <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>(<span style="color:#ae81ff">0</span>, index_size, PROT_READ, MAP_PRIVATE, fd, <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>The second is to have an entry point to actually parse the thing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    WOWS_CONTEXT context;
</span></span><span style="display:flex;"><span>    context.debug <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Start the parsing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">wows_parse_index</span>(index_content, index_size, <span style="color:#f92672">&amp;</span>context);
</span></span></code></pre></div><p>Here, I pass the memory mapped content of the index, its size (will be used in the futur to avoid overflows) and a <code>context</code> which will be used to pass parsing options and maintain &ldquo;states&rdquo; in the parsing if necessary.</p>
<h4 id="parsing-the-header-section">Parsing the header section</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">wows_parse_index</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>contents, <span style="color:#66d9ef">size_t</span> length, WOWS_CONTEXT <span style="color:#f92672">*</span>context) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// header section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  WOWS_INDEX_HEADER <span style="color:#f92672">*</span>header <span style="color:#f92672">=</span> (WOWS_INDEX_HEADER <span style="color:#f92672">*</span>)contents;
</span></span></code></pre></div><p>We can print it with a few <code>printf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_header</span>(WOWS_INDEX_HEADER <span style="color:#f92672">*</span>header) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Index Header Content:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* magic:                     %.4s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>header<span style="color:#f92672">-&gt;</span>magic);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* unknown_1:                 0x%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, header<span style="color:#f92672">-&gt;</span>unknown_1);
</span></span><span style="display:flex;"><span>    [...]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Output</p>
<pre tabindex="0"><code>Index Header Content:
* magic:                     ISFP
* unknown_1:                 0x2000000
* id:                        0xb4399d91
* unknown_2:                 0x40
* file_plus_dir_count:       311
* file_count:                284
* unknown_3:                 1
* header_size:               40
* offset_idx_data_section:   0x3bf6
* offset_idx_footer_section: 0x7136
</code></pre><h4 id="metadata-entries">Metadata entries</h4>
<p>Then, we can do a bunch of pointer arythmetic operation to extract the other sections of the index file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>  <span style="color:#75715e">// Recover the start of the metadata array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  WOWS_INDEX_METADATA_ENTRY <span style="color:#f92672">*</span>metadatas;
</span></span><span style="display:flex;"><span>  metadatas <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      (WOWS_INDEX_METADATA_ENTRY <span style="color:#f92672">*</span>)(contents <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(WOWS_INDEX_HEADER));
</span></span></code></pre></div><p>Then, we do something with these sections, like for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#75715e">// Parse &amp; print each entry in the metadata section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> header<span style="color:#f92672">-&gt;</span>file_plus_dir_count; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (context<span style="color:#f92672">-&gt;</span>debug) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">print_metadata_entry</span>(<span style="color:#f92672">&amp;</span>metadatas[i], i);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>With <code>print_metadata_entry</code> looking like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">print_metadata_entry</span>(WOWS_INDEX_METADATA_ENTRY <span style="color:#f92672">*</span>entry, <span style="color:#66d9ef">int</span> index) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Metadata entry %d:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, index);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* file_type:                 %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, entry<span style="color:#f92672">-&gt;</span>file_type_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* offset_idx_file_name:      0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, entry<span style="color:#f92672">-&gt;</span>offset_idx_file_name);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* unknown_4:                 0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, entry<span style="color:#f92672">-&gt;</span>unknown_4);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* file_type_2:               0x%lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, entry<span style="color:#f92672">-&gt;</span>file_type_2);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="re-interpretingvalidating-some-field-significations">Re-interpreting/validating some field significations</h4>
<p>Once done, it gives us more confortable read:</p>
<pre tabindex="0"><code>[...]
Metadata entry 0:
* file_type:                 14
* offset_idx_file_name:      0x26e0
* unknown_4:                 0x93b6404fba9a0c8f
* file_type_2:               0xdbb1a1d1b108b927

Metadata entry 1:
* file_type:                 19
* offset_idx_file_name:      0x26ce
* unknown_4:                 0xc7f7d0284a87ec8f
* file_type_2:               0x74d821503e1beba4

Metadata entry 2:
* file_type:                 18
* offset_idx_file_name:      0x26c1
* unknown_4:                 0x6b4f2cace7a270ad
* file_type_2:               0xdbb1a1d1b108b927

Metadata entry 3:
[...]

Metadata entry 310:
* file_type:                 19
* offset_idx_file_name:      0x14fb
* unknown_4:                 0xce7afff48d1bd174
* file_type_2:               0x74d821503e1beba4
</code></pre><p>This permits to review our previous reverse and right away there are two interesting things to note:</p>
<ul>
<li>There was a bit of an unknown regarding the number of metadata chunck: was it <code>file_count</code> or <code>file_plus_dir_count</code>? Now we are more certain it&rsquo;s <code>file_plus_dir_count</code> as its the larger value. If it was not, we would try parse a section past the metadatas as metadata with funky results (garbage or crash). This is not the case.</li>
<li><code>file_type</code> in metadata is not a file type/enum. The value are small, but quite varied, it&rsquo;s more likely the length of the file name.</li>
</ul>
<p>Lets check with the last entry:</p>
<pre tabindex="0"><code>Metadata entry 310:
* file_type:                 19
[...]
</code></pre><p><code>hexdump -C system_data.idx| less</code>
[&hellip;]
00003be0  61 72 69 61 74 69 6f 6e  5f 64 75 6d 6d 79 2e 64  |ariation_dummy.d|
00003bf0  64 73 00 77 61 76 65 73  5f 68 65 69 67 68 74 73  |ds.waves_heights|
00003c00  30 2e 64 64 73 00 8f 0c  9a ba 4f 40 b6 93 70 11  |0.dds&hellip;..O@..p.|
00003c10  03 07 0d 33 ed 77 00 00  00 00 00 00 00 00 05 00  |&hellip;3.w&hellip;&hellip;&hellip;.|</p>
<pre tabindex="0"><code>
The last file name is `waves_heights0.dds`, 18 characters long, with the `\0`, we have our 19 value.

So lets rename this field.

Now that we have fixed that, we can recover the file names of each entry:

```C
char *filename = (char *)entry;
filename += entry-&gt;offset_idx_file_name;

printf(&#34;* filename: %.*s\n&#34;, (int)entry-&gt;file_name_size, filename);
</code></pre><p>Nice:</p>
<pre tabindex="0"><code>Metadata entry 0:
* file_name_size:            14
* offset_idx_file_name:      0x26e0
* unknown_4:                 0x93b6404fba9a0c8f
* file_type_2:               0xdbb1a1d1b108b927
* filename:                  KDStorage.bin

Metadata entry 1:
* file_name_size:            19
* offset_idx_file_name:      0x26ce
* unknown_4:                 0xc7f7d0284a87ec8f
* file_type_2:               0x74d821503e1beba4
* filename:                  waves_heights1.dds
</code></pre><p>We have file names and directory names, for example:</p>
<pre tabindex="0"><code>[...]
Metadata entry 10:
* file_name_size:            11
* offset_idx_file_name:      0x2654
* unknown_4:                 0x46c008ccf65395e0
* file_type_2:               0x46e29969bd85cf06
* filename:                  space_defs

Metadata entry 11:
* file_name_size:            13
* offset_idx_file_name:      0x263f
* unknown_4:                 0x7213702d5e6899e0
* file_type_2:               0x13d93873302ed14c
* filename:                  aid_null.dds

Metadata entry 12:
* file_name_size:            16
* offset_idx_file_name:      0x262c
* unknown_4:                 0xa1a829d8713f89e0
* file_type_2:               0xdbb1a1d1b108b927
* filename:                  camouflages.xml
[...]
</code></pre><p>There is something which should enable us to differenciate between the twos, maybe one of the unknown field.</p>
<p>Also, we still need to figure out how the directory system works:</p>
<ul>
<li>How directories &amp; sub directories are composed (to get <code>&lt;dir&gt;/&lt;sub dir&gt;/&lt;sub sub dir&gt;/</code> paths)</li>
<li>How the path goes back to the root (<code>/</code>)</li>
</ul>
<p>We will not look at it here, but that&rsquo;s something to keep in mind.</p>
<h4 id="recovering-the-footer">Recovering the footer</h4>
<p>Now, lets try to recover the pieces of informations from the footer and the metadata chunks.</p>
<p>First, I tried:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>WOWS_INDEX_FOOTER <span style="color:#f92672">*</span>footer <span style="color:#f92672">=</span> (WOWS_INDEX_FOOTER <span style="color:#f92672">*</span>)(contents <span style="color:#f92672">+</span> header<span style="color:#f92672">-&gt;</span>offset_idx_footer_section);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print_footer</span>(footer);
</span></span></code></pre></div><p>But the results seemed off:</p>
<pre tabindex="0"><code>Index Footer Content:
* size_pkg_file_name:        50b0bd0300002d0b
* unknown_7:                 0xe967
* unknown_6:                 0x15
</code></pre><p>A file name size of <code>50b0bd0300002d0b</code> ? I don&rsquo;t think so.</p>
<p>So let&rsquo;s look at it more closely.</p>
<p>In the header, we have:</p>
<pre tabindex="0"><code>Index Header Content:
[...]
* offset_idx_footer_section: 0x7136
[...]
</code></pre><p>The hexdump gives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux 6775398/idx » hexdump -s <span style="color:#ae81ff">6</span> -C system_data.idx| less
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">00007116</span>  <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">67</span> ac <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">22</span> ec ca b8  <span style="color:#ae81ff">70</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">03</span> <span style="color:#ae81ff">07</span> 0d <span style="color:#ae81ff">33</span> ed <span style="color:#ae81ff">77</span>  |!g.p<span style="color:#e6db74">&#34;...p....3.w|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007126  28 f9 15 0a 00 00 00 00  05 00 00 00 01 00 00 00  |(...............|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007136  0b 2d 00 00 03 bd b0 50  67 e9 00 00 00 00 00 00  |.-.....Pg.......|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007146  15 00 00 00 00 00 00 00  18 00 00 00 00 00 00 00  |................|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007156  70 11 03 07 0d 33 ed 77  73 79 73 74 65 6d 5f 64  |p....3.wsystem_d|
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">00007166  61 74 61 5f 30 30 30 31  2e 70 6b 67 00           |ata_0001.pkg.|
</span></span></span></code></pre></div><p>If our previous interpretation was correct, a simple offset from the start of the index file should be <code>0x7146</code>, not <code>0x7136</code>.</p>
<p>Maybe we are missing some fields in the footer, but given the previous 128 bits at offset <code>0x7136</code> really look like the end of a pkg metadata entry, I doubt it.</p>
<p>A more plausible explaination is that the offset is relative to the header <code>id</code> field at <code>0x10</code>.
Maybe the <code>magic</code> + <code>unknown_1 bits</code>, i.e. the first 128 bits are considered to be a separate section.</p>
<p>Anyway, lets just offset by 128 bits.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define MAGIC_SECTION_OFFSET sizeof(uint32_t) * 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Get the footer section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>WOWS_INDEX_FOOTER <span style="color:#f92672">*</span>footer <span style="color:#f92672">=</span> (WOWS_INDEX_FOOTER <span style="color:#f92672">*</span>)(contents <span style="color:#f92672">+</span> header<span style="color:#f92672">-&gt;</span>offset_idx_footer_section <span style="color:#f92672">+</span> MAGIC_SECTION_OFFSET);
</span></span></code></pre></div><p>That&rsquo;s better:</p>
<pre tabindex="0"><code>Index Footer Content:
* size_pkg_file_name:        23
* unknown_7:                 0x18
* unknown_6:                 0xb5a4fa9349d9fd0d
</code></pre><p>We can also recover the pkg file name as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pkg_filename <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)footer;
</span></span><span style="display:flex;"><span>pkg_filename <span style="color:#f92672">+=</span> <span style="color:#66d9ef">sizeof</span>(WOWS_INDEX_FOOTER);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;* pkg filename:              %.*s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>       (<span style="color:#66d9ef">int</span>)footer<span style="color:#f92672">-&gt;</span>size_pkg_file_name, pkg_filename);
</span></span></code></pre></div><h4 id="mid-implementation-though">Mid-implementation though</h4>
<p>The code starts to be extremely unsafe for my tastes, in way too many sections, I trust the offsets and sizes provided by the index file.</p>
<p>Once I&rsquo;m finished with the first parsing implementation/dump, I really need to implement boundary checks.</p>
<h4 id="wows-index-data-file-entries">WOWS INDEX DATA FILE entries</h4>
<p>So, we basically do the same thing we did with the footer, but with the <code>offset_idx_data_section</code> field.</p>
<p>And lets add the 128 bits from the start (hexdump gives us <code>0x3c06</code>, which is again a <code>0x10</code> difference with <code>0x3bf6</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#75715e">// Get pkg data pointer section
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WOWS_INDEX_DATA_FILE_ENTRY <span style="color:#f92672">*</span>data_file_entry <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        (WOWS_INDEX_DATA_FILE_ENTRY <span style="color:#f92672">*</span>)(contents <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       header<span style="color:#f92672">-&gt;</span>offset_idx_data_section <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       MAGIC_SECTION_OFFSET);
</span></span></code></pre></div><p>From there, we are not sure if we have <code>header-&gt;file_plus_dir_count</code> or <code>header-&gt;file_count</code> entries. The latter seems more likely as this section points to the pkg files, but that&rsquo;s not a given.</p>
<p>Also, we are unsure how one entry there is paired with a metadata entry. Maybe the order is simply the same in this array, maybe the matching is done through one of the unknown field.</p>
<p>But first, lets dump the content with some <code>printf</code>:</p>
<pre tabindex="0"><code>Data file entry [0]:
* unknown_5:                 0x93b6404fba9a0c8f
* unknown_6:                 0x77ed330d07031170
* offset_pkg_data_chunk:     0x0
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data_chunk:       0x21f5
* id_pkg_data_chunk:         0x366c
* padding:                   0x4a87ec8f

Data file entry [1]:
* unknown_5:                 0x77ed330d07031170
* unknown_6:                 0x5ef9b1e
* offset_pkg_data_chunk:     0x100000005
* type_1:                    0x11515
* type_2:                    0x97637703
* size_pkg_data_chunk:       0x2ab3e
* id_pkg_data_chunk:         0x6b4f2cace7a270ad
* padding:                   0x7031170
[...]
</code></pre><p>Humm, that doesn&rsquo;t look righ&hellip; Why is the padding not the expected <code>0x0</code>? Also why the first entry looks mostly ok, except the padding, and the rest is garbage.</p>
<p>First, I double-check the <code>WOWS_INDEX_DATA_FILE_ENTRY</code> field sizes, and it was ok.</p>
<p>Then, I remembered that compilers can add padding to have all the fields properly aligned in memory, this helps with performances.</p>
<p>To avoid that, we need to add:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#pragma pack(1)
</span></span></span></code></pre></div><p>Now the output looks like that:</p>
<pre tabindex="0"><code>* unknown_5:                 0x93b6404fba9a0c8f
* unknown_6:                 0x77ed330d07031170
* offset_pkg_data_chunk:     0x0
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data_chunk:       0x21f5
* id_pkg_data_chunk:         0x366c5c4500bf
* padding:                   0x0

Data file entry [1]:
* unknown_5:                 0xc7f7d0284a87ec8f
* unknown_6:                 0x77ed330d07031170
* offset_pkg_data_chunk:     0x5ef9b1e
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data_chunk:       0x11515
* id_pkg_data_chunk:         0x2ab3e97637703
* padding:                   0x0

Data file entry [2]:
* unknown_5:                 0x6b4f2cace7a270ad
* unknown_6:                 0x77ed330d07031170
* offset_pkg_data_chunk:     0x2205
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data_chunk:       0x1cb
* id_pkg_data_chunk:         0xcadc1deb96d
* padding:                   0x0
</code></pre><p>That&rsquo;s much better.</p>
<p>But this small issue raises a number of issues with my method of parsing. Casting to structs comes with numerous issues, from overflows to endianess.</p>
<p>This is not that critical here since we are just trying to have a rough prototype, but on a more critical software, that&rsquo;s not a good idea.</p>
<p>After this prototype, it might be a good idea to start learning Rust ^^.</p>
<p>Also, if we try to parse <code>header-&gt;file_plus_dir_count</code> entries, we get the following:</p>
<pre tabindex="0"><code>Data file entry [283]:
* unknown_5:                 0xb8caec2270ac6721
* unknown_6:                 0x77ed330d07031170
* offset_pkg_data_chunk:     0xa15f928
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data_chunk:       0x2d0b
* id_pkg_data_chunk:         0xe96750b0bd03
* padding:                   0x0

Data file entry [284]:
* unknown_5:                 0x15
* unknown_6:                 0x18
* offset_pkg_data_chunk:     0x77ed330d07031170
* type_1:                    0x74737973
* type_2:                    0x645f6d65
* size_pkg_data_chunk:       0x5f617461
* id_pkg_data_chunk:         0x676b702e31303030
* padding:                   0x0

Data file entry [285]:
* unknown_5:                 0x0
* unknown_6:                 0x0
* offset_pkg_data_chunk:     0x0
* type_1:                    0x0
* type_2:                    0x0
* size_pkg_data_chunk:       0x0
* id_pkg_data_chunk:         0x0
* padding:                   0x0
</code></pre><p>The entry <code>283</code> is ok. This is 284th entry since we start at <code>0</code>, which is exactly <code>header-&gt;file_count</code>. The next one has weird values and the rest just <code>0</code>.</p>
<p>So <code>header-&gt;file_count</code> is indeed the number of entries in this section.</p>
<h4 id="matching-the-metadata-entries-with-the-pkg-file-entries">Matching the metadata entries with the pkg file entries</h4>
<p>The fact that from one side we have <code>header-&gt;file_count</code> and <code>header-&gt;file_plus_dir_count</code> on the other means it&rsquo;s not a simple index matching.</p>
<p>Lets investigate the unknown fields:</p>
<pre tabindex="0"><code>[...]
Data file entry [279]:
* unknown_5:                 0xce7afff48d1bd174
* unknown_6:                 0x77ed330d07031170
[...]

Data file entry [280]:
* unknown_5:                 0x199e99feb0c986f8
* unknown_6:                 0x77ed330d07031170
[...]
</code></pre><p><code>unknown_6</code> is always the same, not really interesting.</p>
<p><code>unknown_5</code> on the contrary is specific to each entry:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux GitHub/wows-depack <span style="color:#f92672">(</span>main<span style="color:#f92672">)</span> » ./wows-depack-cli -i ~/Games/World<span style="color:#ae81ff">\ </span>of<span style="color:#ae81ff">\ </span>Warships/bin/6775398/idx/system_data.idx | grep <span style="color:#e6db74">&#39;unknown_5&#39;</span> | sort | uniq -c
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> * unknown_5:                 0x14b002d7c2835863
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> * unknown_5:                 0x15a7b41a61f65f9c
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> * unknown_5:                 0x15fcab5401f27f56
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> * unknown_5:                 0x18a0d0dc4b05f8fa
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1</span> * unknown_5:                 0x192a05120f00553e
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>The values however are present two times, one in the Metadata entry, the other in the data file entry:</p>
<pre tabindex="0"><code>Metadata entry [72]:
[...]
* unknown_4:                 0x1011b17d9304bb39
[...]
</code></pre><pre tabindex="0"><code>Data file entry [65]:
[...]
* unknown_5:                 0x1011b17d9304bb39
[...]
</code></pre><p>So the link is established through these fields. These are simply random, unique ID for each entry.</p>
<p>In fact <code>unknown_4</code> and <code>unknown_5</code> are not the only fields leveraging this.</p>
<p>Looking at <code>file_type_2</code> values, we get something like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux GitHub/wows-depack <span style="color:#f92672">(</span>main *<span style="color:#f92672">)</span> » ./wows-depack-cli -i ~/Games/World<span style="color:#ae81ff">\ </span>of<span style="color:#ae81ff">\ </span>Warships/bin/6775398/idx/system_data.idx | grep <span style="color:#e6db74">&#39;0x937f155e4baaf562\|filename:&#39;</span> | grep -A <span style="color:#ae81ff">1</span> <span style="color:#e6db74">&#39;0x937f155e4baaf562&#39;</span>           
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  LowerAftTrans.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  MidBarbette.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  Bulkhead.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  MidBelt.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* unknown_4:                 0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  armour
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  Bottom.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  ConstrBig.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  ConstrMid.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  ConstrSm.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span>* file_type_2:               0x937f155e4baaf562
</span></span><span style="display:flex;"><span>* filename:                  DoubleBottom.dds
</span></span><span style="display:flex;"><span>--
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Ok, <code>file_type_2</code> is not a file type at all, it&rsquo;s the <code>id</code> (<code>unknown_4</code> right now) of just one node that really looks like a directory.</p>
<p><code>file_type_2</code> should probably renamed <code>parent_id</code> or something.</p>
<p>Also, <code>unknown_6</code> follows the same logic, it&rsquo;s the id of the footer entry (side note: maybe the format supports having one index for several files).</p>
<h3 id="recap-of-the-format">Recap of the format</h3>
<p>During these first steps in the implementation, we managed to figure out quite a bit about the format.</p>
<p>So lets recap the format at this point:</p>
<h4 id="general-format">General format</h4>
<p>The index file is composed of 5 sections:</p>
<pre tabindex="0"><code>|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| ^
|           Header           | } index header (number of files, pointers to sections, etc)                                     
|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| v

|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| ^
|       File metadata 1      | |
|----------------------------| |
|           [...]            | } metadata section (pointer to name, type, etc)
|----------------------------| |
|      File metadata Nfd     | |       
|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| v

|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| ^
|        File Name 1         | |
|----------------------------| |
|           [...]            | } file names (`\0` separated strings)
|----------------------------| |
|        File Name Nfd       | |
|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| v

|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| ^
|   File `.pkg` pointers 1   | |
|----------------------------| |
|           [...]            | }  pkg pointers section in the `.pkg` file (offsets)
|----------------------------| |
|   File `.pkg` pointers Nf  | |
|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| v

|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| ^
|           Footer           | } index footer (corresponding `.pkg` file name)    
|~~~~~~~~~~~~~~~~~~~~~~~~~~~~| V
</code></pre><h4 id="header-1">Header</h4>
<pre tabindex="0"><code>+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| MA | MA | MA | MA || 00 | 00 | 00 | 02 || ID | ID | ID | ID || 40 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;----- magic -----&gt;||&lt;--- unknown_1 ---&gt;||&lt;------- id ------&gt;||&lt;--- unknown_2 ---&gt;|            
|     32 bits       ||      32 bits      ||     32 bits       ||      32 bits      |

+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+
| FD | FD | FD | FD || FO | FO | FO | FO || 01 | 00 | 00 | 00 || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====++====+====+====+====++====+====+====+====+            
|&lt;- file_dir_count &gt;||&lt;-- file_count ---&gt;||&lt;-------------- unknown_3 -------------&gt;|            
|     32 bits       ||      32 bits      ||                64 bits                 |

+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+            
| HS | HS | HS | HS | HS | HS | HS | HS  ||  OF | OF | OF | OF | OF | OF | OF | OF |
+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
|&lt;------------- header_size ------------&gt;||&lt;------- offset_idx_data_section ------&gt;|
|                64 bits                 ||             64 bits                    |

+====+====+====+====+====+====+====+=====+  
| OE | OE | OE | OE | OE | OE | OE | OE  |
+====+====+====+====+====+====+====+=====+
|&lt;----- offset_idx_footer_section ------&gt;|                
|               64 bits                  |
</code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>magic</code></td>
<td>32 bits</td>
<td>Magic bytes, always &ldquo;ISFP&rdquo;</td>
</tr>
<tr>
<td><code>unknown_1</code></td>
<td>32 bits</td>
<td>Unknown, always 0x2000000</td>
</tr>
<tr>
<td><code>id</code></td>
<td>32 bits</td>
<td>Unsure, unique per index file, not referenced anywhere else</td>
</tr>
<tr>
<td><code>unknown_2</code></td>
<td>32 bits</td>
<td>Unknown, always 0x40, maybe some offset</td>
</tr>
<tr>
<td><code>file_dir_count</code></td>
<td>32 bits</td>
<td>Number of files + directories (Nfd), also number of entries in the metadata section and the file names section</td>
</tr>
<tr>
<td><code>file_count</code></td>
<td>32 bits</td>
<td>Number of files (Nf), also the number of entries in the file pkg pointers section</td>
</tr>
<tr>
<td><code>unknown_3</code></td>
<td>64 bits</td>
<td>Unknown, always &lsquo;1&rsquo;, maybe the number of <code>.pkg</code> file the index file references (the format hints that it might be supported, but it&rsquo;s not used)</td>
</tr>
<tr>
<td><code>header_size</code></td>
<td>64 bits</td>
<td>Most likely the header size, always 40</td>
</tr>
<tr>
<td><code>offset_idx_data_section</code></td>
<td>64 bits</td>
<td>Offset to the pkg data section, the offset is computed from <code>file_plus_dir_count</code> so <code>0x10</code> needs to be added</td>
</tr>
<tr>
<td><code>offset_idx_footer_section</code></td>
<td>64 bits</td>
<td>Offset to the footer section, the offset is computed from <code>file_plus_dir_count</code> so  <code>0x10</code> needs to be added</td>
</tr>
</tbody>
</table>
<h4 id="file-metadata">File metadata</h4>
<p>This section is repeated for each file and directory (<code>header-&gt;file_dir_count</code>).</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
| NS | NS | NS | NS | NS | NS | NS | NS  ||  OF | OF | OF | OF | OF | OF | OF | OF |
+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
|&lt;---------- file_name_size ------------&gt;||&lt;-------- offset_idx_file_name --------&gt;|
|               64 bits                  ||              64 bits                   |

+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
| UN | UN | UN | UN | UN | UN | UN | UN  ||  T2 | T2 | T2 | T2 | T2 | T2 | T2 | T2 |
+====+====+====+====+====+====+====+=====++=====+====+====+====+====+====+====+====+
|&lt;----------------- id -----------------&gt;||&lt;------------- parent_id  -------------&gt;|
|                64 bits                 ||                64 bits                 |

[...repeat...]      
</code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>file_name_size</code></td>
<td>64 bits</td>
<td>Size of the file name string</td>
</tr>
<tr>
<td><code>offset_idx_file_name</code></td>
<td>64 bits</td>
<td>Offset from the start of the current metadata record to the start of the file name string</td>
</tr>
<tr>
<td><code>id</code></td>
<td>64 bits</td>
<td>Unique ID of the metadata record</td>
</tr>
<tr>
<td><code>parent_id</code></td>
<td>64 bits</td>
<td>ID of the potential parent record (in particular, a directory record)</td>
</tr>
</tbody>
</table>
<h4 id="file-names-section">File names section</h4>
<p>This section is just <code>\0</code> separated list of strings:</p>
<pre tabindex="0"><code>+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+====+
|             file name string         | 00 |
+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+====+
[...repeat...]
</code></pre><h4 id="file-pkg-pointers">File &ldquo;.pkg&rdquo; pointers</h4>
<p>This section  is repeated for each file (<code>header-&gt;file_count</code>).</p>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
| UO | UO | UO | UO | UO | UO | UO | UO ||  UT | UT | UT | UT | UT | UT | UT | UT |
+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
|&lt;----------- metadata_id -------------&gt;||&lt;------------- footer_id --------------&gt;|
|               64 bits                 ||                64 bits                 |

+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
| OF | OF | OF | OF | OF | OF | OF | OF || T1 | T1 | T1 | T1 || T2 | T2 | T2 | T2 |
+====+====+====+====+====+====+====+====++====+====+====+====++====+====+====+====+
|&lt;--------- offset_pkg_data -----------&gt;||&lt;---- type_1 -----&gt;||&lt;----- type_2 ----&gt;|
|               64 bits                 ||     32 bits       ||      32 bits      |

+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
| OE | OE | OE | OE || ID | ID | ID | ID | ID | ID | ID | ID || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
|&lt;- size_pkg_data -&gt;||&lt;------------ id_pkg_data ------------&gt;||&lt;---- padding ----&gt;|
|     32 bits       ||               64 bits                 ||      32 bits      |
[...repeat...]
</code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>metadata_id</code></td>
<td>64 bits</td>
<td>ID of the corresponding metadata entry</td>
</tr>
<tr>
<td><code>footer_id</code></td>
<td>64 bits</td>
<td>ID of the footer entry (only one entry possible in practice)</td>
</tr>
<tr>
<td><code>offset_pkg_data</code></td>
<td>64 bits</td>
<td>Offset to the compressed data from the start of the <code>.pkg</code> file</td>
</tr>
<tr>
<td><code>type_1</code></td>
<td>32 bits</td>
<td>Some kind of type, role unknown</td>
</tr>
<tr>
<td><code>type_2</code></td>
<td>32 bits</td>
<td>Some kind of type, role unknown</td>
</tr>
<tr>
<td><code>size_pkg_data</code></td>
<td>32 bits</td>
<td>Size of the compressed data section in the <code>.pkg</code> file</td>
</tr>
<tr>
<td><code>id_pkg_data</code></td>
<td>64 bits</td>
<td>ID of the data section in the <code>.pkg</code> file</td>
</tr>
<tr>
<td><code>padding</code></td>
<td>32 bits</td>
<td>Always <code>0x00000000</code></td>
</tr>
</tbody>
</table>
<h4 id="footer">Footer</h4>
<pre tabindex="0"><code>+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
| UO | UO | UO | UO | UO | UO | UO | UO ||  U3 | U3 | U3 | U3 | U3 | U3 | U3 | U3 |
+====+====+====+====+====+====+====+====++=====+====+====+====+====+====+====+====+
|&lt;--------- pkg_file_name_size --------&gt;||&lt;-------------- unknown_7 -------------&gt;|
|               64 bits                 ||                64 bits                 |

+====+====+====+====+====+====+====+====++~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~...
| UT | UT | UT | UT | UT | UT | UT | UT ||             pkg_file_name_string
+====+====+====+====+====+====+====+====++~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~...
|&lt;----------------- id -----------------&gt;|
|                64 bits                 |
</code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pkg_file_name_size</code></td>
<td>64 bits</td>
<td>Size of the corresponding <code>.pkg</code> file name string</td>
</tr>
<tr>
<td><code>unknown_7</code></td>
<td>64 bits</td>
<td>unknown, looks like an ID</td>
</tr>
<tr>
<td><code>id</code></td>
<td>64 bits</td>
<td>ID of the footer entry</td>
</tr>
</tbody>
</table>
<h4 id="pkg-format">PKG format</h4>
<p>The <code>.pkg</code> format is rather simple, it&rsquo;s bunch of concatenated compressed (RFC 1951/Deflate) data blobs (one for each file) separated by an ID.</p>
<pre tabindex="0"><code>+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+
|                                                                                 |
|                      Compressed Data (RFC 1951/Deflate)                         |
|                                                                                 |
+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~+
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
| 00 | 00 | 00 | 00 || XX | XX | XX | XX | XX | XX | 00 | 00 || 00 | 00 | 00 | 00 |
+====+====+====+====++====+====+====+====+====+====+====+====++====+====+====+====+
|&lt;--- padding_1 ---&gt;||&lt;---------------- id -----------------&gt;||&lt;--- padding_2 ---&gt;|
|     32 bits       ||               64 bits                 ||      32 bits      |

[...repeat...]
</code></pre><table>
<thead>
<tr>
<th>Field</th>
<th>Size</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>padding_1</code></td>
<td>32 bits</td>
<td>Always <code>0x00000000</code></td>
</tr>
<tr>
<td><code>id_pkg_data</code></td>
<td>64 bits</td>
<td>ID of the data blob</td>
</tr>
<tr>
<td><code>padding_2</code></td>
<td>32 bits</td>
<td>Always <code>0x00000000</code></td>
</tr>
</tbody>
</table>
<h3 id="back-to-the-implementation">Back to the implementation</h3>
<h4 id="small-tangent">Small tangent</h4>
<p>By this point, I was a bit intrigued by the <code>type_1</code> and <code>type_2</code> fields in the <code>pkg</code> pointer sections.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kakwa@linux GitHub/wows-depack <span style="color:#f92672">(</span>main<span style="color:#f92672">)</span> » <span style="color:#66d9ef">for</span> i in ~/Games/World<span style="color:#ae81ff">\ </span>of<span style="color:#ae81ff">\ </span>Warships/bin/6775398/idx/*;<span style="color:#66d9ef">do</span> ./wows-depack-cli -i <span style="color:#e6db74">&#34;</span>$i<span style="color:#e6db74">&#34;</span>| grep <span style="color:#e6db74">&#39;type_[12]:&#39;</span>  ;<span style="color:#66d9ef">done</span> | sort -n | uniq -c | sort -n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">57265</span> * type_1:                    0x0
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">57265</span> * type_2:                    0x0
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">232089</span> * type_1:                    0x5
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">232089</span> * type_2:                    0x1
</span></span></code></pre></div><p>Ok, it seems that <code>(type_1, type_2)</code> can either have the <code>(0x0, 0x0)</code> values, or the <code>(0x5, 0x1)</code> values. In most cases, it&rsquo;s the latter.</p>
<p>Looking at a few <code>(0x0, 0x0)</code>, a common file with such values are <code>.png</code>.</p>
<p>It&rsquo;s a bit of a wild guess, but these might be compression levels. <code>(0x0, 0x0)</code>, ie no compression would be logical for <code>.png</code> as these files are already compressed. Compressing them would actually only cost CPU resources with no space gains.</p>
<p>For now, lets just keep that in mind, we will revisit it later.</p>
<h4 id="glueing-the-entries-together">Glueing the entries together</h4>
<p>So, we have metadata entries which can be linked together, we have pkg pointer entries which are linked to metadata entries and footer entries.</p>
<p>It&rsquo;s time to link all that together.</p>
<p>To do that, the obvious choice is to feed these IDs into an hash map, this will make look-ups easier and quicker.</p>
<p>Once done, the output now looks like that:</p>
<pre tabindex="0"><code>File entry [259]:
* metadata_id:               0xc90b3d356989c551
* footer_id:                 0x77ed330d07031170
* offset_pkg_data:           0x5d30db8
* type_1:                    0x5
* type_2:                    0x1
* size_pkg_data:             0x89667
* id_pkg_data:               0xaab740ef4f6a6
* padding:                   0x0
* file_name_size:            18
* offset_idx_file_name:      0x164e
* id:                        0xc90b3d356989c551
* parent_id:                 0xeb7ddcfb5178376
* filename:                  snow_tiles_ah.dds
parent [1]:
* file_name_size:            8
* offset_idx_file_name:      0x19cf
* id:                        0xeb7ddcfb5178376
* parent_id:                 0xb220a7743c83e638
* filename:                  weather
parent [2]:
* file_name_size:            5
* offset_idx_file_name:      0x16a3
* id:                        0xb220a7743c83e638
* parent_id:                 0x3837637adc4586b1
* filename:                  maps
parent [3]:
* file_name_size:            7
* offset_idx_file_name:      0x1746
* id:                        0x3837637adc4586b1
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  system
</code></pre><p>This entry is for the following path: <code>/system/maps/weather/snow_tiles_ah.dds</code></p>
<p>This should be enough now to start thinking about the actual tool and how it will be implemented.</p>
<h4 id="another-tangent">Another tangent</h4>
<p>The goal is in the end is to parse all the index files, so it got me curious about the IDs across the different files.</p>
<p>Looking at the dumps, <code>content</code> is a fairly common directory name, present in a lot of the index files.</p>
<p>And if we look at these records, we get:</p>
<pre tabindex="0"><code>kakwa@linux GitHub/wows-depack (main *%) » for i in ~/Games/World\ of\ Warships/bin/6775398/idx/*;do echo $i; ./wows-depack-cli -i &#34;$i&#34; |grep -B 5  &#39;* filename:                  content$&#39;;done|less                                                                                                                 130 ↵

/home/kakwa/Games/World of Warships/bin/6775398/idx/basecontent.idx
parent [5]:
* file_name_size:            8
* offset_idx_file_name:      0x470b7
* id:                        0xa33046442d8327fc
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  content
--
parent [5]:
* file_name_size:            8
* offset_idx_file_name:      0x470b7
* id:                        0xa33046442d8327fc
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  content
[...]
/home/kakwa/Games/World of Warships/bin/6775398/idx/camouflage.idx
parent [5]:
* file_name_size:            8
* offset_idx_file_name:      0xecae
* id:                        0xa33046442d8327fc
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  content
--
parent [4]:
* file_name_size:            8
* offset_idx_file_name:      0xecae
* id:                        0xa33046442d8327fc
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  content
--
parent [5]:
* file_name_size:            8
* offset_idx_file_name:      0xecae
* id:                        0xa33046442d8327fc
* parent_id:                 0xdbb1a1d1b108b927
* filename:                  content
[...]
</code></pre><p>Interestingly <code>id</code> is always <code>0xa33046442d8327fc</code> (and also <code>parent_id</code> is <code>0xdbb1a1d1b108b927</code>). This will make implementation a bit easier.</p>
<p>However, it raises an interesting question: how this <code>id</code> is generated? Is it completely random? Or is it derived from the path/name?</p>
<p>It&rsquo;s not really critical to read files, but might be important to write content if we ever get to that.</p>
<h3 id="implementing-a-pseudo-inode-system">Implementing a pseudo-inode system</h3>
<p>The next step in the implementation was to implement a pseudo inode system.</p>
<p>The first step was to have a convenient way to recover a <code>metadata</code> or <code>pkg_data</code> chunk by id.</p>
<p>To do so, I simply used an <a href="https://github.com/tidwall/hashmap.c">hashmap</a>.</p>
<p>Then, I created two inode types:</p>
<ul>
<li>directory</li>
<li>file</li>
</ul>
<p>Then, I created a function that starts with the <code>pkg_data</code> chunks. These are our files.</p>
<p>Then I jumped into the metadata section, gather a few bits about the file, mainly its name.</p>
<p>From the file metadata, I do a look-up for its <code>parent_id</code>, and then recursively for the parents of the parent. This are our directories.</p>
<p>The recursion ends when the <code>parent_id</code> doesn&rsquo;t match any metadata <code>id</code> (weirdly enough, root is not identified by a specific id).</p>
<p>In the end, it gives us a <code>root</code> inode, with childrens, file or directory. The directory themselves can also have childrens.</p>
<p>That&rsquo;s our archive tree represented.</p>
<p>With a bit more work, adding a path/tree printer function, I now get something like that:</p>
<pre tabindex="0"><code>/postfx_animations.xml
/settings/Default_v3.settings
/settings/Default_v1.settings
/settings/Default_v2.settings
/scripts/user_data_object_defs/Barge.def
/scripts/user_data_object_defs/SpatialUIDebugTool.def
/scripts/user_data_object_defs/FogPoint.def
/scripts/user_data_object_defs/StaticSoundEmitter.def
[...]
/helpers/maps/green_hemisphere.dds
/helpers/maps/lev_dirt01.dds
/helpers/maps/fat_disc_quarter.dds
/helpers/maps/lev_grass_01.dds
/helpers/maps/lev_grassflowers.dds
/helpers/maps/red_ruler.dds
/helpers/maps/hemisphere.dds
/helpers/maps/disc_quarter.dds
/helpers/maps/red_hemisphere_ring.dds
/server_stats.xml
</code></pre><p>Or that in (ugly) tree form:</p>
<pre tabindex="0"><code>-./
 |-* postfx_animations.xml
 |--settings/
 |  |-* Default_v3.settings
 |  |-* Default_v1.settings
 |  |-* Default_v2.settings
 |--scripts/
 |  |--user_data_object_defs/
 |  |  |-* Barge.def
 |  |  |-* SpatialUIDebugTool.def
 |  |  |-* FogPoint.def
 |  |  |-* StaticSoundEmitter.def
 |  |  |-* Minefield.def
 |  |  |-* SoundedEffect.def
 |  |  |-* SquadronReticleTool.def
 |  |  |-* Trigger.def
 |  |  |-* WayPoint.def
[...]
</code></pre><p>With this pseudo inode system, we will be able to do some neat stuff, like extract by path, extract a whole (sub)tree, implement a search function, or even implement some <a href="https://en.wikipedia.org/wiki/Filesystem_in_Userspace">FUSE</a> module.</p>
<h3 id="unit-test--ia">Unit test &amp; IA</h3>
<p>Then I got a bit distracted. At work lots of folks were talking about IAs, so I decided to give it a go.</p>
<p>Up until know I had zero unit tests and kind of gave-up on the idea.</p>
<p>But I tried using chatgpt, first on small stuff like error code to error string conversion, and it worked really well.</p>
<p>Then I just feed it the structs describing the index file, and asked it to create a cunit unit test.</p>
<p>To my surprise, it was able to understand the format relatively well, and was even able to generate mostly correct test index data (it messed-up a bit around <code>file_names</code> strings and <code>offsets</code>, but still).</p>
<p>So I ended-up actually having a pretty decent code coverage for this project.</p>
<p>It even me helped start a limited write support by providing me with a first draft of an index writer function.</p>
<p>That&rsquo;s really impressive, and honestly, kind of frightening. But it&rsquo;s definitely a tool I will start using quite heavily.</p>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>



<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/kakwa">Pierre-Francois Carpentier</a> 2024</p>
    
  </div>
</section>





</body>
</html>

